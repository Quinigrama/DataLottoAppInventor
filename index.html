
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>🎲 DataLotto49 Mobile</title>

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --danger-light: #fca5a5;
      --warning: #f59e0b;
      --info: #06b6d4;
      --dark: #1f2937;
      --light: #f9fafb;
      --gray: #6b7280;
      --border-radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    input, textarea {
      -webkit-user-select: text;
      -khtml-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    html {
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      scroll-behavior: smooth;
      overflow-x: hidden;
      overflow-y: auto;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      color: var(--dark);
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 0 5px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      position: relative;
    }

    .header h1 {
      color: var(--primary);
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      color: var(--gray);
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
    }

    .disclaimer-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 32px;
      height: 32px;
      border: 2px solid var(--warning);
      background: var(--warning);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      animation: disclaimerPulse 2s infinite;
    }

    .disclaimer-btn:hover {
      background: #e68900;
      border-color: #e68900;
      transform: scale(1.1);
    }

    @keyframes disclaimerPulse {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
      }
      50% { 
        box-shadow: 0 0 0 8px rgba(245, 158, 11, 0);
      }
    }

    .selected-numbers {
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
    }

    .selected-numbers h3 {
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-align: center;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .selected-display {
      min-height: 50px;
      border: 2px dashed #e5e7eb;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }

    .number-selection-section {
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
    }

    .number-selection-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    .number-selection-header h3 {
      color: var(--primary);
      text-align: center;
      margin: 0;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .selection-mode-controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .selection-mode-btn {
      width: 42px;
      height: 42px;
      border: 3px solid;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: clamp(1.1rem, 3vw, 1.4rem);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      background: #f5f5f5;
    }

    .selection-mode-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .selection-mode-btn[data-mode="cold"] {
      border-color: #2196f3;
      background: #e3f2fd;
      color: #1976d2;
    }

    .selection-mode-btn[data-mode="hot"] {
      border-color: #f44336;
      background: #ffebee;
      color: #d32f2f;
    }

    .selection-mode-btn[data-mode="excluded"] {
      border-color: #9e9e9e;
      background: #f5f5f5;
      color: #616161;
    }

    .selection-mode-btn[data-mode="data"] {
      border-color: #4caf50;
      background: #e8f5e8;
      color: #2e7d32;
    }

    .selection-mode-btn[data-mode="simulate"] {
      border-color: #ff9800;
      background: #fff3e0;
      color: #f57c00;
    }

    .selection-mode-btn.active {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      animation: pulse-selection 2s infinite;
    }

    .selection-mode-btn.active[data-mode="cold"] {
      border-color: #1976d2;
      background: #2196f3;
      color: white;
      box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
    }

    .selection-mode-btn.active[data-mode="hot"] {
      border-color: #d32f2f;
      background: #f44336;
      color: white;
      box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
    }

    .selection-mode-btn.active[data-mode="excluded"] {
      border-color: #616161;
      background: #9e9e9e;
      color: white;
      box-shadow: 0 8px 25px rgba(158, 158, 158, 0.4);
    }

    .selection-mode-btn.active[data-mode="data"] {
      border-color: #2e7d32;
      background: #4caf50;
      color: white;
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
    }

    .selection-mode-btn.active[data-mode="simulate"] {
      border-color: #f57c00;
      background: #ff9800;
      color: white;
      box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
    }

    @keyframes pulse-selection {
      0%, 100% { transform: scale(1.1); }
      50% { transform: scale(1.2); }
    }

    #randomBtn:hover {
      transform: rotate(360deg) scale(1.05);
    }

    #clearBtn {
      transition: all 0.3s ease;
      border-color: #9e9e9e;
      background: #f5f5f5;
      color: #616161;
    }

    #clearBtn:hover {
      transform: scale(1.1);
    }

    #clearBtn.has-selections {
      background: var(--danger-light);
      border-color: var(--danger-light);
      color: white;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
      20%, 40%, 60%, 80% { transform: translateX(2px); }
    }

    #clearBtn.shake {
      animation: shake 0.5s ease-in-out;
    }

    .numbers-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      max-width: 100%;
      margin: 0 auto;
    }

    @media(min-width: 480px) {
      .numbers-grid {
        gap: 6px;
      }
    }

    .number-ball {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid #e0e0e0;
      background: linear-gradient(135deg, #fafafa, #f0f0f0);
      position: relative;
      font-size: clamp(0.7rem, 2.5vw, 1rem);
      min-height: 35px;
    }

    .number-ball:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .number-ball.selected {
      background: linear-gradient(135deg, #ffd700, #ffa000);
      border-color: #ff8f00;
      color: white;
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(255,193,7,0.4);
      animation: pulse 1.5s infinite;
    }

    .number-ball.generated-pick {
      background: linear-gradient(135deg, #9333ea, #c084fc);
      color: white;
      transform: scale(1.05);
      border-color: #7c3aed;
      box-shadow: 0 0 15px rgba(147, 51, 234, 0.4);
    }

    .number-ball.random-pick {
      background: var(--warning);
      color: white;
      transform: scale(1.05);
      border-color: #e68900;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1.1); }
      50% { transform: scale(1.2); }
    }

    .number-ball.hot {
      border-color: #ff5722;
      background: linear-gradient(135deg, #ffebee, #ffcdd2);
      color: #d32f2f;
      box-shadow: 0 0 10px rgba(255, 87, 34, 0.3);
    }

    .number-ball.cold {
      border-color: #03a9f4;
      background: linear-gradient(135deg, #e1f5fe, #b3e5fc);
      color: #0277bd;
      box-shadow: 0 0 10px rgba(3, 169, 244, 0.3);
    }

    .number-ball.excluded {
      background: #757575;
      border-color: #424242;
      color: white;
      opacity: 0.6;
      cursor: not-allowed;
    }

    .number-ball .number-icon {
      position: absolute;
      top: -3px;
      right: -3px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      font-size: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border: 1px solid white;
    }

    .number-ball.hot .number-icon {
      background: #ff5722;
      color: white;
    }

    .number-ball.cold .number-icon {
      background: #03a9f4;
      color: white;
    }

    .number-ball.excluded .number-icon {
      background: #9e9e9e;
      color: white;
    }

    .number-ball.random-pick .number-icon {
      background: var(--warning);
      color: white;
      border-color: #e68900;
    }

    .number-ball.generated-pick .number-icon {
      background: #7c3aed;
      color: white;
      border-color: #a855f7;
    }

    /* SECCIONES COLAPSABLES */
    .collapsible-section {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
      overflow: hidden;
    }

    .collapsible-header {
      padding: 15px;
      background: var(--light);
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .collapsible-header:hover {
      background: #f3f4f6;
    }

    .collapsible-header h3 {
      color: var(--primary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .collapse-btn {
      width: 30px;
      height: 30px;
      border: none;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .collapse-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }

    .collapse-btn.collapsed {
      transform: rotate(0deg);
    }

    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .collapsible-content.expanded {
      max-height: 2000px;
      transition: max-height 0.5s ease-in;
    }

    .collapsible-inner {
      padding: 15px;
    }

    .data-analysis-section {
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
    }

    .data-analysis-section h3 {
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .data-info {
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      color: var(--gray);
      text-align: center;
    }

    .data-info.has-data {
      background: #e8f5e8;
      color: var(--success);
      font-weight: bold;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    @media(max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-item {
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--gray);
      margin-bottom: 3px;
    }

    .stat-value {
      font-weight: bold;
      color: var(--dark);
      font-size: 0.9rem;
    }

    .stat-value.valid {
      color: #4caf50;
      text-shadow: 0 0 10px rgba(76,175,80,0.3);
    }

    .stat-value.invalid {
      color: var(--danger);
    }

    .strategy-section {
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
    }

    .strategy-section h3 {
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .strategy-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    @media(max-width: 480px) {
      .strategy-buttons {
        grid-template-columns: 1fr;
      }
    }

    .strategy-btn {
      padding: 12px 8px;
      background: #f3f4f6;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
      font-size: 0.9rem;
    }

    .strategy-btn:hover {
      transform: translateY(-2px);
      border-color: var(--primary);
    }

    .strategy-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .input-row label {
      font-weight: bold;
      color: var(--dark);
      min-width: 60px;
      font-size: 0.9rem;
    }

    .input-row input {
      width: 70px;
      padding: 6px 10px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .input-row input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .input-row span {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .number-option {
      padding: 8px;
      background: #f3f4f6;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .number-option:hover {
      background: var(--primary);
      color: white;
    }

    .number-option.active {
      background: var(--primary);
      color: white;
    }

    .generate-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      font-size: clamp(1rem, 3vw, 1.1rem);
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      animation: generatePulse 2s infinite;
    }

    .generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    @keyframes generatePulse {
      0%, 100% { 
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
      }
      50% { 
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
      }
    }

    .ticket {
      background: linear-gradient(135deg, #fff8e1, #ffecb3);
      border: 2px dashed #ff9800;
      border-radius: 15px;
      padding: 15px;
      margin-top: 15px;
      display: none;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      0% { transform: translateY(20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    .ticket.show {
      display: block;
    }

    .ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e5e7eb;
      text-align: center;
      color: #e65100;
      flex-wrap: wrap;
    }

    .ticket-header h4 {
      color: var(--primary);
      font-size: clamp(1rem, 3vw, 1.1rem);
    }

    .ticket-header p {
      color: var(--gray);
      font-size: clamp(0.8rem, 2vw, 0.9rem);
    }

    .ticket-combination {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: white;
      border-radius: 10px;
      margin-bottom: 8px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: clamp(0.8rem, 2.5vw, 1rem);
    }

    .ticket-number {
      width: 25px;
      height: 25px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(0.7rem, 2vw, 0.9rem);
      flex-shrink: 0;
    }

    .ticket-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .ticket-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: var(--transition);
      font-size: 0.9rem;
    }

    .ticket-btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .save-btn {
      background: linear-gradient(135deg, #2196f3, #1976d2);
      color: white;
    }

    .share-btn {
      background: linear-gradient(135deg, #4caf50, #388e3c);
      color: white;
    }

    .ticket-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    .filter-group {
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
      margin-bottom: 10px;
      transition: var(--transition);
    }

    .filter-group.active {
      background: #f7f3ff;
      border-left-color: var(--secondary);
    }

    .filter-title {
      font-weight: bold;
      color: var(--dark);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .range-control {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .range-control input {
      width: 70px;
      padding: 6px 10px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .range-control input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .range-control input.error {
      border-color: var(--danger);
      background-color: #fef2f2;
    }

    .range-control span {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .filter-chip {
      padding: 6px 12px;
      background: #f3f4f6;
      border-radius: 15px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
    }

    .filter-chip:hover {
      border-color: var(--primary);
    }

    .filter-chip.active {
      border-color: #4caf50;
      background: #e8f5e8;
      color: #2e7d32;
    }
    
    .filter-chip.favor {
      border-color: var(--info);
      background: #e0f7fa;
      color: #006064;
    }
    
    .switch-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    .filter-info-text {
        font-size: 0.8rem;
        color: var(--gray);
        margin-top: 8px;
        padding: 8px;
        background-color: #f3f4f6;
        border-radius: 6px;
    }

    .validation-error {
      background: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.8rem;
      margin-top: 5px;
      display: none;
    }

    .validation-error.show {
      display: block;
    }

    .saved-tickets-section {
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 80px;
    }

    .saved-tickets-section h3 {
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .saved-tickets {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .saved-ticket-item {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
    }

    .saved-ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .saved-ticket-date {
      font-weight: bold;
      color: var(--dark);
      font-size: clamp(0.8rem, 2.5vw, 0.95rem);
    }

    .saved-ticket-actions {
      display: flex;
      gap: 8px;
    }

    .validate {
      background: var(--success);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .delete-btn {
      background: var(--danger) !important;
      color: white !important;
      border: none;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      transition: var(--transition);
    }

    .delete-btn:hover {
      background: #dc2626 !important;
      transform: scale(1.05);
    }

    .toggle-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .saved-combinations {
      margin-top: 8px;
      padding: 8px;
      background: #f9fafb;
      border-radius: 6px;
      display: none;
    }

    .saved-combination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px;
      background: white;
      border-radius: 4px;
      margin-bottom: 4px;
    }

    .hit-count {
      font-size: 0.8rem;
      font-weight: bold;
      color: var(--success);
      background-color: #e8f9f1;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .saved-combination-number {
      width: 18px;
      height: 18px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    .saved-combination-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Loading */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .loading-content {
      background: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      max-width: 90%;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f4f6;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 15px;
      width: 95%;
      max-width: 400px;
      max-height: 80vh;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      margin-bottom: 15px;
      flex-shrink: 0;
    }

    .modal-header h3 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .modal-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 15px;
      flex-shrink: 0;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    #validationResults {
      flex: 1;
      overflow-y: auto;
      max-height: 200px;
      margin-bottom: 15px;
      padding-right: 5px;
    }

    #validationResults::-webkit-scrollbar {
      width: 6px;
    }

    #validationResults::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    #validationResults::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    #validationResults::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-shrink: 0;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .modal-btn.cancel {
      background: #f3f4f6;
      color: var(--dark);
    }

    .modal-btn.confirm {
      background: var(--success);
      color: white;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      opacity: 0;
      transform: translateX(-50%) translateY(20px);
      transition: all 0.3s ease;
      max-width: 90%;
      text-align: center;
      font-size: 0.9rem;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
    }

    .hidden-file-input {
      display: none;
    }

    @media(max-width: 320px) {
      .numbers-grid {
        gap: 2px;
      }

      .number-ball {
        min-height: 30px;
        font-size: 0.6rem;
      }

      .selection-mode-btn {
        width: 38px;
        height: 38px;
        font-size: 1rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1>🎲 DataLotto49</h1>
      <p>Generador Inteligente con Arquitectura Matemática Avanzada</p>
      <button class="disclaimer-btn" id="disclaimerBtn" title="Disclaimer Ético">⚠️</button>
    </header>

    <div class="selected-numbers">
      <h3>🎯 Números Seleccionados</h3>
      <div class="selected-display" id="selectedDisplay">
        <div style="color:#666; font-style: italic;">Selecciona hasta 6 números</div>
      </div>
    </div>

    <div class="number-selection-section">
      <div class="number-selection-header">
        <h3>Selección de números</h3>
        <div class="selection-mode-controls">
          <button class="selection-mode-btn active" data-mode="cold" title="Marcar/Desmarcar números fríos">
            <span class="icon">❄</span>
          </button>
          <button class="selection-mode-btn" data-mode="hot" title="Marcar/Desmarcar números calientes">
            <span class="icon">🔥</span>
          </button>
          <button class="selection-mode-btn" data-mode="excluded" title="Marcar/Desmarcar números excluidos">
            <span class="icon">🚫</span>
          </button>
          <button class="selection-mode-btn" data-mode="data" title="Cargar base de datos" id="dataBtn">
            <span class="icon">📊</span>
          </button>
          <button class="selection-mode-btn" data-mode="simulate" title="Simular datos" id="simulateBtn">
            <span class="icon">🎰</span>
          </button>
          <button class="selection-mode-btn" id="randomBtn" title="Seleccionar 6 números al azar">
            <span class="icon">🎲</span>
          </button>
          <button class="selection-mode-btn" id="clearBtn" title="Limpiar todas las selecciones">
            <span class="icon">🗑️</span>
          </button>
        </div>
      </div>

      <div class="numbers-grid" id="numbersGrid"></div>
    </div>

    <!-- Analizador Estadístico -->
    <div class="data-analysis-section">
      <h3>📊 Analizador Estadístico Base</h3>
      <div class="data-info" id="dataInfo">
        No hay datos cargados. Carga una base de datos CSV/DB o simula datos históricos.
      </div>
      <div class="stats-grid" id="dataStatsGrid" style="display: none;">
        <div class="stat-item">
          <div class="stat-label">Total Sorteos</div>
          <div class="stat-value" id="totalDraws">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Tipo de Datos</div>
          <div class="stat-value" id="dataType">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Números Más Frecuentes</div>
          <div class="stat-value" id="mostFrequent">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Números Menos Frecuentes</div>
          <div class="stat-value" id="leastFrequent">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Chi-cuadrado (p-valor)</div>
          <div class="stat-value" id="chiSquare">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Sesgo Detectado</div>
          <div class="stat-value" id="biasDetected">-</div>
        </div>
      </div>
    </div>

    <!-- Estadísticas Colapsables -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="stats">
        <h3>📊 Estadísticas en Tiempo Real</h3>
        <button class="collapse-btn collapsed" id="statsCollapseBtn">+</button>
      </div>
      <div class="collapsible-content" id="statsContent">
        <div class="collapsible-inner">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">Suma Total</div>
              <div class="stat-value" id="statSuma">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Par/Impar</div>
              <div class="stat-value" id="statParImpar">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Bajos/Altos</div>
              <div class="stat-value" id="statBajosAltos">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Decenas</div>
              <div class="stat-value" id="statDecenas">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Agrup. Decenas</div>
              <div class="stat-value" id="statAgrupDecenas">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Consecutivos</div>
              <div class="stat-value" id="statConsecutivos">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Suma Dígitos</div>
              <div class="stat-value" id="statSumaDigitos">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Números Primos</div>
              <div class="stat-value" id="statPrimos">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Desviación</div>
              <div class="stat-value" id="statDesviacion">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Entropía</div>
              <div class="stat-value" id="statEntropia">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="strategy-section">
      <h3>♟ Estrategia de Juego</h3>
      <div class="strategy-buttons">
        <div class="strategy-btn active" data-strategy="simple">
          <div style="font-size: 1.5rem; margin-bottom: 5px;">🎯</div>
          <div>Simple</div>
        </div>
        <div class="strategy-btn" data-strategy="winning">
          <div style="font-size: 1.5rem; margin-bottom: 5px;">🏆</div>
          <div>Estrategia Ganadora</div>
        </div>
        <div class="strategy-btn" data-strategy="multiple">
          <div style="font-size: 1.5rem; margin-bottom: 5px;">🎰</div>
          <div>Múltiple</div>
        </div>
      </div>

      <div class="multiple-options" id="winningOptions" style="display: none;">
        <div class="input-row">
          <label>Generar:</label>
          <input type="number" id="generateCount" value="100" min="10" max="1000">
          <span>combinaciones</span>
        </div>
        <div class="input-row">
          <label>Jugar:</label>
          <input type="number" id="playCount" value="10" min="1" max="100">
          <span>mejores</span>
        </div>
      </div>

      <div class="multiple-numbers-options" id="multipleNumbersOptions" style="display: none;">
        <div class="numbers-select">
          <label>¿Cuántos números quieres seleccionar?</label>
          <div class="number-option active" data-numbers="7">7 números</div>
          <div class="number-option" data-numbers="8">8 números</div>
          <div class="number-option" data-numbers="9">9 números</div>
          <div class="number-option" data-numbers="10">10 números</div>
          <div class="number-option" data-numbers="11">11 números</div>
        </div>
      </div>

      <button class="generate-btn" id="generateBtn"><span>🤞 Generar Combinación</span></button>

      <div class="ticket" id="ticket">
        <div class="ticket-header">
          <h4>🎫 Tu Boleto Ganador</h4>
          <p id="ticketDate"></p>
        </div>
        <div id="ticketCombinations"></div>
        <div class="ticket-actions">
          <button class="ticket-btn save-btn" id="saveBtn"><span>💾 Guardar Boleto</span></button>
          <button class="ticket-btn share-btn" id="shareBtn"><span>📤 Compartir</span></button>
        </div>
      </div>
    </div>

    <!-- Filtros Matemáticos Jerárquicos Colapsables -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="filters">
        <h3>⚙️ Panel de Control de Filtros Avanzados</h3>
        <button class="collapse-btn collapsed" id="filtersCollapseBtn">+</button>
      </div>
      <div class="collapsible-content" id="filtersContent">
        <div class="collapsible-inner">
          <div class="filters-panel">
            <!-- GRUPO: Excluir Terminaciones -->
            <div class="filter-group" title="Excluye cualquier combinación que contenga un número terminado en los dígitos seleccionados. Por ejemplo, si seleccionas '7', se excluirán los números 7, 17, 27, 37, 47.">
              <div class="filter-title">🚫 Excluir Terminaciones</div>
              <div class="filter-options" id="terminacionesOptions">
                <div class="filter-chip" data-value="0">0</div>
                <div class="filter-chip" data-value="1">1</div>
                <div class="filter-chip" data-value="2">2</div>
                <div class="filter-chip" data-value="3">3</div>
                <div class="filter-chip" data-value="4">4</div>
                <div class="filter-chip" data-value="5">5</div>
                <div class="filter-chip" data-value="6">6</div>
                <div class="filter-chip" data-value="7">7</div>
                <div class="filter-chip" data-value="8">8</div>
                <div class="filter-chip" data-value="9">9</div>
              </div>
            </div>

            <!-- GRUPO: Filtros de Balance -->
            <div class="filter-group" title="La suma de los 6 números. Estadísticamente, la mayoría de los sorteos ganadores suman entre 121 y 190.">
              <div class="filter-title">🎯 Suma Total</div>
              <div class="range-control">
                <input type="number" id="sumMin" value="121" min="21" max="279">
                <span>a</span>
                <input type="number" id="sumMax" value="190" min="21" max="279">
              </div>
              <div class="validation-error" id="sumError">El valor mínimo no puede ser mayor que el máximo</div>
            </div>

            <div class="filter-group" title="Proporción de números pares e impares. Las proporciones 4/2, 3/3 y 2/4 son las más comunes.">
              <div class="filter-title">⚖️ Par/Impar</div>
              <div class="filter-options" id="parImparOptions">
                <div class="filter-chip" data-value="6/0">6P/0I</div>
                <div class="filter-chip" data-value="5/1">5P/1I</div>
                <div class="filter-chip active" data-value="4/2">4P/2I</div>
                <div class="filter-chip active" data-value="3/3">3P/3I</div>
                <div class="filter-chip active" data-value="2/4">2P/4I</div>
                <div class="filter-chip" data-value="1/5">1P/5I</div>
                <div class="filter-chip" data-value="0/6">0P/6I</div>
              </div>
            </div>

            <div class="filter-group" title="Proporción de números bajos (1-25) y altos (26-49). Proporciones equilibradas como 3/3, 4/2 y 2/4 son frecuentes.">
              <div class="filter-title">📊 Bajos/Altos</div>
              <div class="filter-options" id="bajosAltosOptions">
                <div class="filter-chip" data-value="6/0">6B/0A</div>
                <div class="filter-chip" data-value="5/1">5B/1A</div>
                <div class="filter-chip active" data-value="4/2">4B/2A</div>
                <div class="filter-chip active" data-value="3/3">3B/3A</div>
                <div class="filter-chip active" data-value="2/4">2B/4A</div>
                <div class="filter-chip" data-value="1/5">1B/5A</div>
                <div class="filter-chip" data-value="0/6">0B/6A</div>
              </div>
            </div>

            <!-- GRUPO: Filtros Estructurales -->
             <div class="filter-group" title="Cantidad de números primos (2, 3, 5, 7...). Generalmente, hay entre 1 y 3 primos en un sorteo.">
              <div class="filter-title">🔢 Números Primos</div>
              <div class="range-control">
                <span>Entre</span>
                <input type="number" id="primosMin" value="1" min="0" max="6">
                <span>y</span>
                <input type="number" id="primosMax" value="3" min="0" max="6">
                <span>primos</span>
              </div>
              <div class="validation-error" id="primosError">El valor mínimo no puede ser mayor que el máximo</div>
            </div>
            
            <div class="filter-group" title="Agrupación de números consecutivos. '1/1/1/1/1/1' significa que no hay consecutivos.">
              <div class="filter-title">🔗 Números Consecutivos</div>
              <div class="filter-options" id="consecutivosOptions">
                <div class="filter-chip" data-value="6">6</div>
                <div class="filter-chip" data-value="5/1">5/1</div>
                <div class="filter-chip" data-value="4/2">4/2</div>
                <div class="filter-chip" data-value="4/1/1">4/1/1</div>
                <div class="filter-chip" data-value="3/3">3/3</div>
                <div class="filter-chip" data-value="3/2/1">3/2/1</div>
                <div class="filter-chip" data-value="3/1/1/1">3/1/1/1</div>
                <div class="filter-chip" data-value="2/2/2">2/2/2</div>
                <div class="filter-chip" data-value="2/2/1/1">2/2/1/1</div>
                <div class="filter-chip active" data-value="2/1/1/1/1">2/1/1/1/1</div>
                <div class="filter-chip active" data-value="1/1/1/1/1/1">1/1/1/1/1/1</div>
              </div>
            </div>

            <div class="filter-group" title="Distribución de los números en las decenas (1-9, 10-19...). '3/2/1' indica 3 números en una decena, 2 en otra y 1 en una tercera.">
              <div class="filter-title">🔢 Agrupación por Decenas</div>
              <div class="filter-options" id="agrupDecenasOptions">
                <div class="filter-chip active" data-value="6">6</div>
                <div class="filter-chip active" data-value="5/1">5/1</div>
                <div class="filter-chip active" data-value="4/2">4/2</div>
                <div class="filter-chip active" data-value="4/1/1">4/1/1</div>
                <div class="filter-chip active" data-value="3/3">3/3</div>
                <div class="filter-chip active" data-value="3/2/1">3/2/1</div>
                <div class="filter-chip active" data-value="3/1/1/1">3/1/1/1</div>
                <div class="filter-chip active" data-value="2/2/2">2/2/2</div>
                <div class="filter-chip active" data-value="2/2/1/1">2/2/1/1</div>
                <div class="filter-chip active" data-value="2/1/1/1/1">2/1/1/1/1</div>
              </div>
            </div>
            
            <div class="filter-group" title="La suma de todos los dígitos individuales de los 6 números. Es un filtro más sutil para refinar la selección.">
              <div class="filter-title">∑ Suma de Dígitos</div>
              <div class="range-control">
                <input type="number" id="sumaDigitosMin" value="28" min="21" max="63">
                <span>a</span>
                <input type="number" id="sumaDigitosMax" value="45" min="21" max="63">
              </div>
              <div class="validation-error" id="sumaDigitosError">El valor mínimo no puede ser mayor que el máximo</div>
            </div>
            
            <!-- GRUPO: Filtros Estadísticos Avanzados -->
             <div class="filter-group" title="Mide la dispersión de los números. Un valor bajo significa que los números están muy juntos; un valor alto, que están muy separados. El rango 12-18 es común.">
              <div class="filter-title">📈 Desviación Estándar</div>
              <div class="range-control">
                <input type="number" id="desviacionMin" value="12.0" min="1" max="24" step="0.1">
                <span>a</span>
                <input type="number" id="desviacionMax" value="18.0" min="1" max="24" step="0.1">
              </div>
              <div class="validation-error" id="desviacionError">El valor mínimo no puede ser mayor que el máximo</div>
            </div>

            <div class="filter-group" title="Entropía de Shannon: Mide la 'aleatoriedad' o dispersión de los números en el tablero. Valores más altos indican mayor dispersión. Rango típico: 2.3 - 2.5.">
                <div class="filter-title">🌀 Entropía (Shannon)</div>
                <div class="range-control">
                  <input type="number" id="entropyMin" value="2.3" min="1.0" max="2.6" step="0.05">
                  <span>a</span>
                  <input type="number" id="entropyMax" value="2.5" min="1.0" max="2.6" step="0.05">
                </div>
                <div class="validation-error" id="entropyError">El valor mínimo no puede ser mayor que el máximo</div>
            </div>
            
            <!-- GRUPO: Filtros Geométricos -->
            <div class="filter-group" title="Evita o favorece combinaciones que formen visuales en el tablero 7x7.">
              <div class="filter-title">🗺️ Patrones Geométricos (Detección Real)</div>
              <div class="filter-options" id="geometricOptions">
                <div class="filter-chip" data-value="lineas">🚫 Líneas</div>
                <div class="filter-chip" data-value="diagonales">🚫 Diagonales</div>
                <div class="filter-chip" data-value="triangulos">🚫 Triángulos</div>
                <div class="filter-chip" data-value="circulos">🚫 Círculos</div>
                <div class="filter-chip" data-value="cruces">🚫 Cruces</div>
                <div class="filter-chip" data-value="espaciados">👍 Espaciados</div>
              </div>
            </div>

            <!-- GRUPO: Filtros Predictivos (IA) -->
            <div class="filter-group" title="Utiliza modelos matemáticos avanzados basados en datos históricos y de comportamiento para optimizar la selección.">
              <div class="filter-title">🤖 Filtros Predictivos (IA)</div>
              <div class="switch-control">
                <label class="switch">
                  <input type="checkbox" id="useMarkovSwitch">
                  <span class="slider"></span>
                </label>
                <span>Activar Cadenas de Markov</span>
              </div>
               <div class="switch-control" style="margin-top: 10px;">
                <label class="switch">
                  <input type="checkbox" id="useNashSwitch">
                  <span class="slider"></span>
                </label>
                <span>Activar Optimización Nash (Anti-Popular)</span>
              </div>
              <div class="filter-info-text">
                <b>Markov:</b> Analiza secuencias en datos históricos. <b>Nash:</b> Favorece números menos populares para maximizar premios potenciales (usa datos simulados de popularidad).
              </div>
            </div>
            
          </div>
        </div>
      </div>
    </div>

    <div class="saved-tickets-section">
      <h3>🗂 Boletos Guardados</h3>
      <div class="saved-tickets" id="savedTickets">
        <div style="color:#666; text-align: center; padding: 20px;">No tienes boletos guardados</div>
      </div>
    </div>

    <!-- Modales -->
    <div class="loading" id="loadingModal">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <h3 id="loadingText">Generando combinación...</h3>
        <p>Intentos: <span id="loadingAttempts">0</span></p>
      </div>
    </div>

    <div class="modal" id="validationModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>🔍 Validar Boleto</h3>
          <p>Introduce los 6 números ganadores separados por espacios, comas o puntos.</p>
        </div>
        <input type="text" class="modal-input" id="winningNumbersInput" placeholder="7, 12. 23 31,42.49" maxlength="23">
        <div id="validationResults"></div>
        <div class="modal-actions">
          <button class="modal-btn cancel" id="cancelValidationBtn">Cerrar</button>
          <button class="modal-btn confirm" id="confirmValidationBtn">Validar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Disclaimer -->
    <div class="modal" id="disclaimerModal">
      <div class="modal-content" style="max-height: 85vh; overflow-y: auto;">
        <div class="modal-header">
          <h3>⚠️ Disclaimer Ético</h3>
        </div>
        <div style="padding: 15px; color: var(--dark); line-height: 1.6; overflow-y: auto; max-height: 60vh;">
          <p><strong>IMPORTANTE:</strong></p>
          <p>Esta aplicación es una herramienta de entretenimiento y análisis estadístico. Los números de lotería son completamente aleatorios.</p>
          <p><strong>Recuerda:</strong></p>
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li>No hay forma de predecir números ganadores</li>
            <li>Juega solo lo que puedas permitirte perder</li>
            <li>El juego puede crear adicción</li>
            <li>Esta app no garantiza premios</li>
            <li>Los algoritmos son para análisis, no predicción</li>
            <li>Los datos históricos no predicen futuros resultados</li>
            <li>Los filtros matemáticos solo organizan probabilidades</li>
            <li>Las estrategias no aumentan las posibilidades reales de ganar</li>
          </ul>
          <p><strong>Responsabilidad:</strong></p>
          <p>El usuario es completamente responsable de sus decisiones de juego. Esta herramienta no fomenta el juego compulsivo.</p>
          <p><strong>Ayuda:</strong></p>
          <p>Si tienes problemas con el juego, busca ayuda profesional. En España: <strong>900 200 225</strong> (Línea de ayuda contra la ludopatía)</p>
          <p style="margin-top: 15px; padding: 10px; background: #fef2f2; border-left: 4px solid var(--danger); border-radius: 4px;">
            <strong>AVISO LEGAL:</strong> Esta aplicación es solo para entretenimiento. Los desarrolladores no se responsabilizan por pérdidas económicas derivadas del uso de esta herramienta.
          </p>
        </div>
        <div class="modal-actions">
          <button class="modal-btn confirm" id="disclaimerCloseBtn">Entendido</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" class="hidden-file-input" accept=".csv,.db" multiple>
  </div>

  <script>
// ============================================
// SISTEMA DE ALMACENAMIENTO PERSISTENTE
// ============================================

window.loadDataFromAppInventor = function(fileContent) {
  if (window.app) {
    try {
      const data = window.app.parseCSVData(fileContent);
      window.app.historicalData = data;
      window.app.dataType = 'real';
      window.app.dataLoaded = true;
      window.app.updateDataAnalysis();
      window.app.analyzeNumbers();
      window.app.updateGridWithHotColdNumbers();
      window.app.showToast(`✅ Datos cargados desde App Inventor: ${data.length} sorteos`, 'success');
    } catch (error) {
      window.app.showToast(`Error al procesar datos del archivo: ${error.message}`, 'error');
    }
  }
};

window.receiveAppInventorTickets = function(jsonString) {
  try {
    const data = JSON.parse(jsonString);
    if (data.action === 'TICKETS_LOADED' && window.app) {
      window.app.savedTickets = data.tickets || [];
      window.app.updateSavedTickets();
      console.log(`Cargados ${data.tickets ? data.tickets.length : 0} boletos desde App Inventor`);
    } else if (data.action === 'TICKETS_SAVED' && window.app) {
      window.app.showToast('Boletos guardados en App Inventor', 'success');
    }
  } catch(error) {
    console.error('Error procesando datos de App Inventor:', error);
  }
};

function detectPlatform() {
  if (typeof window.AppInventor !== 'undefined' || 
      window.location.href.includes('appinventor') ||
      navigator.userAgent.includes('AppInventor')) {
    return 'appinventor';
  } else if (window.location.href.includes('appmaker.xyz') ||
             typeof window.appmaker !== 'undefined') {
    return 'appmaker';
  } else {
    return 'web';
  }
}

function requestFileFromAppInventor() {
    if (typeof window.AppInventor !== 'undefined') {
        window.AppInventor.setWebViewString(JSON.stringify({
            action: 'REQUEST_FILE_PICK'
        }));
    } else {
        console.warn("La función para solicitar archivos solo está disponible en App Inventor.");
        if (window.app) {
            window.app.showToast("Esta función solo está disponible en la app Android.", "warning");
        }
    }
}


    // Clase principal de la aplicación
    class DataLotto49Advanced {
      constructor() {
        // Estado del sistema
        this.selectedNumbers = [];
        this.excludedNumbers = new Set();
        this.hotNumbers = new Set();
        this.coldNumbers = new Set();
        this.currentSelectionMode = 'cold';
        this.isGenerating = false;
        this.savedTickets = [];
        this.currentTicket = null;
        this.currentValidatingTicket = null;
        this.historicalData = [];
        this.numberStats = {};
        this.analysisPeriod = 100;
        this.dataLoaded = false;
        this.dataType = 'none';
        this.platform = detectPlatform();

        // Filtros matemáticos
        this.filters = {
          terminaciones: [],
          sum: { min: 121, max: 190 },
          parImpar: ['4/2', '3/3', '2/4'],
          bajosAltos: ['4/2', '3/3', '2/4'],
          primos: { min: 1, max: 3 },
          consecutivos: ['2/1/1/1/1', '1/1/1/1/1/1'],
          agrupDecenas: ['6', '5/1', '4/2', '4/1/1', '3/3', '3/2/1', '3/1/1/1', '2/2/2', '2/2/1/1', '2/1/1/1/1'],
          sumaDigitos: { min: 28, max: 45 },
          desviacion: { min: 12.0, max: 18.0 },
          entropy: { min: 2.3, max: 2.5 },
          geometric: { exclude: [], favor: [] },
          useMarkov: false,
          useNash: false,
        };

        // Matriz geométrica 7x7
        this.geometricMatrix = this.buildMatrix7x7();
        
        // Modelos AI
        this.transitionMatrix = {}; // Markov
        this.popularityMatrix = []; // Nash
        this.primes = new Set([2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47]);

        // Inicializar
        this.init();
      }

      init() {
        this.initializeHistoricalData();
        this.initializeNumberStats();
        this.buildPopularityMatrix();
        this.analyzeNumbers();
        this.createNumbersGrid();
        this.bindEvents();
        this.loadTickets();
        this.updateFilters();
        if (this.platform === 'appinventor') {
            this.requestInitialDataFromAppInventor();
        }
      }
      
      requestInitialDataFromAppInventor() {
        if (typeof window.AppInventor !== 'undefined') {
            window.AppInventor.setWebViewString(JSON.stringify({ action: 'REQUEST_TICKETS' }));
        }
      }

      // ===== MATRIZ GEOMÉTRICA =====
      buildMatrix7x7() {
        const matrix = {};
        let num = 1;
        for (let row = 0; row < 7; row++) {
          for (let col = 0; col < 7; col++) {
            if (num <= 49) {
              matrix[num] = { x: col, y: row, num };
              num++;
            }
          }
        }
        return matrix;
      }

      // ===== DATOS HISTÓRICOS =====
      initializeHistoricalData() {
        if (!this.dataLoaded) {
          this.simulateHistoricalData(500);
        }
      }

      simulateHistoricalData(numDraws = 500) {
        this.historicalData = [];
        const baseDate = new Date();
        baseDate.setDate(baseDate.getDate() - numDraws * 3.5);

        for(let i = 0; i < numDraws; i++) {
          const drawDate = new Date(baseDate);
          drawDate.setDate(drawDate.getDate() + (i * 3.5));
          const numbers = this.generateRealisticDraw();
          this.historicalData.push({
            id: i + 1,
            date: drawDate,
            numbers: numbers.sort((a, b) => a - b),
            sum: numbers.reduce((a, b) => a + b, 0)
          });
        }
        
        this.dataType = 'simulated';
        this.dataLoaded = true;
        this.updateDataAnalysis();
        this.analyzeNumbers();
        this.updateGridWithHotColdNumbers();
        this.showToast('✅ Datos simulados generados correctamente', 'success');
      }

      generateRealisticDraw() {
        const numbers = new Set();
        const ranges = [
          { min: 1, max: 9, weight: 0.8 },
          { min: 10, max: 19, weight: 1.0 },
          { min: 20, max: 29, weight: 1.0 },
          { min: 30, max: 39, weight: 1.0 },
          { min: 40, max: 49, weight: 0.8 }
        ];

        while(numbers.size < 6) {
          const totalWeight = ranges.reduce((sum, r) => sum + r.weight, 0);
          let rand = Math.random() * totalWeight;
          let selectedRange = null;

          for(const range of ranges) {
            rand -= range.weight;
            if(rand <= 0) {
              selectedRange = range;
              break;
            }
          }

          if(selectedRange) {
            let attempts = 0;
            while(attempts < 10) {
              const num = Math.floor(Math.random() * (selectedRange.max - selectedRange.min + 1)) + selectedRange.min;
              if(!numbers.has(num)) {
                numbers.add(num);
                break;
              }
              attempts++;
            }
          }
        }

        return Array.from(numbers);
      }

      async loadRealData(files) {
        try {
          this.historicalData = [];
          let totalDraws = 0;
          
          for (const file of files) {
            const data = await this.loadDataFile(file);
            this.historicalData.push(...data);
            totalDraws += data.length;
          }
          
          this.historicalData.sort((a, b) => new Date(a.date) - new Date(b.date));
          this.historicalData.forEach((draw, index) => {
            draw.id = index + 1;
          });
          
          this.dataType = 'real';
          this.dataLoaded = true;
          this.updateDataAnalysis();
          this.analyzeNumbers();
          this.updateGridWithHotColdNumbers();
          
          this.showToast(`✅ Datos reales cargados: ${totalDraws} sorteos`, 'success');
          
        } catch (error) {
          this.showToast(`Error cargando datos: ${error.message}`, 'error');
        }
      }

      async loadDataFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const content = e.target.result;
              const data = this.parseCSVData(content);
              resolve(data);
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = () => reject(new Error('Error leyendo archivo'));
          reader.readAsText(file);
        });
      }

      parseCSVData(content) {
        const lines = content.trim().split('\n');
        const draws = [];
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const numbers = line.split(/[,;\t\s]+/).map(n => parseInt(n.trim())).filter(n => !isNaN(n));
          
          if (numbers.length !== 6) {
            throw new Error(`Línea ${i + 1}: Se esperan 6 números, se encontraron ${numbers.length}`);
          }
          
          if (numbers.some(n => n < 1 || n > 49)) {
            throw new Error(`Línea ${i + 1}: Números fuera del rango 1-49`);
          }
          
          draws.push({
            id: i + 1,
            date: new Date(Date.now() - (lines.length - i) * 3.5 * 24 * 60 * 60 * 1000),
            numbers: numbers.sort((a, b) => a - b),
            sum: numbers.reduce((a, b) => a + b, 0)
          });
        }
        
        return draws;
      }

      updateDataAnalysis() {
        const dataInfo = document.getElementById('dataInfo');
        const dataStatsGrid = document.getElementById('dataStatsGrid');
        
        if (!this.dataLoaded || this.historicalData.length === 0) {
          dataInfo.textContent = 'No hay datos cargados. Carga una base de datos CSV/DB o simula datos históricos.';
          dataInfo.className = 'data-info';
          dataStatsGrid.style.display = 'none';
          return;
        }
        
        const frequencies = {};
        for (let i = 1; i <= 49; i++) frequencies[i] = 0;
        
        this.historicalData.forEach(draw => {
          draw.numbers.forEach(num => frequencies[num]++);
        });
        
        const sortedFreq = Object.entries(frequencies).sort((a, b) => b[1] - a[1]);
        const mostFrequent = sortedFreq.slice(0, 3).map(([num]) => num).join(', ');
        const leastFrequent = sortedFreq.slice(-3).map(([num]) => num).join(', ');
        
        const chiSquareResult = this.performChiSquareTest(frequencies);
        
        dataInfo.innerHTML = `📊 ${this.historicalData.length} sorteos cargados (${this.dataType === 'real' ? 'DATOS REALES' : 'DATOS SIMULADOS'})`;
        dataInfo.className = 'data-info has-data';
        
        document.getElementById('totalDraws').textContent = this.historicalData.length;
        document.getElementById('dataType').textContent = this.dataType === 'real' ? 'REALES' : 'SIMULADOS';
        document.getElementById('mostFrequent').textContent = mostFrequent;
        document.getElementById('leastFrequent').textContent = leastFrequent;
        document.getElementById('chiSquare').textContent = chiSquareResult.pValue.toFixed(4);
        document.getElementById('biasDetected').textContent = chiSquareResult.biased ? 'SÍ' : 'NO';
        
        dataStatsGrid.style.display = 'grid';
      }

      performChiSquareTest(frequencies) {
        const totalDraws = this.historicalData.length;
        const expectedFreq = totalDraws * 6 / 49;
        
        let chiSquare = 0;
        for (let i = 1; i <= 49; i++) {
          const observed = frequencies[i];
          chiSquare += Math.pow(observed - expectedFreq, 2) / expectedFreq;
        }
        
        const criticalValue = 65.17;
        const pValue = chiSquare > criticalValue ? 0.001 : 0.5;
        const biased = chiSquare > criticalValue;
        
        return { chiSquare, pValue, biased };
      }

      // ===== ANÁLISIS DE NÚMEROS Y MODELOS =====
      initializeNumberStats() {
        for(let i = 1; i <= 49; i++) {
          this.numberStats[i] = {
            frequency: 0,
            lastAppearance: -1,
            relativeFreq: 0,
            trend: 0,
            cycle: 0,
            score: 0
          };
        }
      }

      analyzeNumbers() {
        this.initializeNumberStats();
        
        const analysisData = this.historicalData.slice(-this.analysisPeriod);
        const totalDraws = analysisData.length;
        if (totalDraws === 0) return;

        analysisData.forEach((draw, index) => {
          draw.numbers.forEach(num => {
            this.numberStats[num].frequency++;
            this.numberStats[num].lastAppearance = index;
          });
        });

        for(let num = 1; num <= 49; num++) {
          const stats = this.numberStats[num];
          stats.relativeFreq = (stats.frequency / totalDraws) * 100;

          const recentDraws = analysisData.slice(-20);
          const recentFrequency = recentDraws.filter(draw => draw.numbers.includes(num)).length;
          const olderDraws = analysisData.slice(-40, -20);
          const olderFrequency = olderDraws.filter(draw => draw.numbers.includes(num)).length;
          stats.trend = recentFrequency - olderFrequency;

          if(stats.lastAppearance === -1) {
            stats.cycle = totalDraws;
          } else {
            stats.cycle = totalDraws - 1 - stats.lastAppearance;
          }

          stats.score = this.calculateCompositeScore(num);
        }

        this.classifyNumbers();
        this.buildTransitionMatrix();
      }

      calculateCompositeScore(num) {
        const stats = this.numberStats[num];
        const avgFreq = this.analysisPeriod / 6;
        const freqComponent = (stats.frequency - avgFreq) / avgFreq;
        const trendComponent = Math.max(-1, Math.min(1, stats.trend));
        const maxCycle = this.analysisPeriod * 0.5;
        const cycleComponent = (maxCycle - stats.cycle) / maxCycle;

        return (freqComponent * 0.4) + (trendComponent * 0.3) + (cycleComponent * 0.3);
      }

      classifyNumbers() {
        const scores = Object.values(this.numberStats).map(s => s.score);
        const sortedScores = [...scores].sort((a, b) => a - b);
        const hotThreshold = sortedScores[Math.floor(sortedScores.length * 0.7)];
        const coldThreshold = sortedScores[Math.floor(sortedScores.length * 0.3)];

        this.hotNumbers.clear();
        this.coldNumbers.clear();
        for (let num = 1; num <= 49; num++) {
          const score = this.numberStats[num].score;
          if (score >= hotThreshold) {
            this.hotNumbers.add(num);
          } else if (score <= coldThreshold) {
            this.coldNumbers.add(num);
          }
        }
      }

      updateGridWithHotColdNumbers() {
        for (let i = 1; i <= 49; i++) {
          const ball = document.querySelector(`.number-ball[data-number="${i}"]`);
          if (ball) {
            ball.classList.remove('hot', 'cold');
            if (this.hotNumbers.has(i)) {
              ball.classList.add('hot');
            } else if (this.coldNumbers.has(i)) {
              ball.classList.add('cold');
            }
          }
        }
      }

      buildTransitionMatrix(order = 2) {
        const transitions = {};
        const data = this.historicalData.map(d => d.numbers);

        for (let i = 0; i < data.length - order; i++) {
            const currentState = data.slice(i, i + order).flat().sort((a, b) => a - b).join(',');
            const nextNumbers = data[i + order];

            if (!transitions[currentState]) {
                transitions[currentState] = {};
            }

            nextNumbers.forEach(num => {
                transitions[currentState][num] = (transitions[currentState][num] || 0) + 1;
            });
        }
        
        // Normalize
        for (const state in transitions) {
            const total = Object.values(transitions[state]).reduce((a, b) => a + b, 0);
            for (const num in transitions[state]) {
                transitions[state][num] /= total;
            }
        }
        this.transitionMatrix = transitions;
      }
      
      buildPopularityMatrix() {
          this.popularityMatrix = new Array(50).fill(0);
          // Simulate birthday bias and pattern preference
          for (let i = 1; i <= 31; i++) this.popularityMatrix[i] += Math.random() * 0.5 + 0.5;
          for (let i = 1; i <= 12; i++) this.popularityMatrix[i] += Math.random() * 0.3;
          [7, 14, 21, 28, 35, 42, 49].forEach(n => this.popularityMatrix[n] += Math.random() * 0.2);
          
          const total = this.popularityMatrix.reduce((a, b) => a + b, 0);
          this.popularityMatrix = this.popularityMatrix.map(p => p / total);
      }


      // ===== UI SETUP =====
      createNumbersGrid() {
        const grid = document.getElementById('numbersGrid');
        grid.innerHTML = '';
        for (let i = 1; i <= 49; i++) {
          const ball = document.createElement('div');
          ball.classList.add('number-ball');
          ball.dataset.number = i;
          ball.textContent = i;
          if (this.hotNumbers.has(i)) ball.classList.add('hot');
          if (this.coldNumbers.has(i)) ball.classList.add('cold');
          grid.appendChild(ball);
        }
      }

      bindEvents() {
        // Number selection
        document.getElementById('numbersGrid').addEventListener('click', e => {
          if (e.target.classList.contains('number-ball')) {
            this.handleNumberClick(e.target);
          }
        });

        // Mode controls
        document.querySelector('.selection-mode-controls').addEventListener('click', e => {
          const btn = e.target.closest('.selection-mode-btn');
          if (btn) {
            const mode = btn.dataset.mode;
            if (mode) {
              this.updateSelectionMode(mode);
            } else if (btn.id === 'randomBtn') {
              this.randomSelect();
            } else if (btn.id === 'clearBtn') {
              this.clearSelections();
            } else if (btn.id === 'dataBtn') {
              if (this.platform === 'appinventor') {
                requestFileFromAppInventor();
              } else {
                document.getElementById('fileInput').click();
              }
            } else if (btn.id === 'simulateBtn') {
              this.simulateHistoricalData(500);
            }
          }
        });

        // Collapsible sections
        document.querySelectorAll('.collapsible-header').forEach(header => {
          header.addEventListener('click', () => {
            const targetId = header.dataset.target;
            const content = document.getElementById(`${targetId}Content`);
            const btn = document.getElementById(`${targetId}CollapseBtn`);
            content.classList.toggle('expanded');
            btn.textContent = content.classList.contains('expanded') ? '-' : '+';
            btn.classList.toggle('collapsed');
          });
        });

        // Strategy buttons
        document.querySelectorAll('.strategy-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.strategy-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const strategy = btn.dataset.strategy;
            this.updateStrategyUI(strategy);
          });
        });

        document.querySelectorAll('.number-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.number-option').forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                this.clearSelections();
            });
        });


        // Generate button
        document.getElementById('generateBtn').addEventListener('click', () => this.generateCombinations());

        // Ticket actions
        document.getElementById('saveBtn').addEventListener('click', () => this.saveTicket());
        document.getElementById('shareBtn').addEventListener('click', () => this.shareTicket());

        // Filters
        document.querySelector('.filters-panel').addEventListener('input', e => {
           if(e.target.tagName === 'INPUT') this.updateFilters();
        });
        document.querySelector('.filters-panel').addEventListener('click', e => {
           if(e.target.classList.contains('filter-chip')) this.updateFilters();
        });

        // Modals
        document.getElementById('disclaimerBtn').addEventListener('click', () => this.toggleModal('disclaimerModal', true));
        document.getElementById('disclaimerCloseBtn').addEventListener('click', () => this.toggleModal('disclaimerModal', false));
        document.getElementById('cancelValidationBtn').addEventListener('click', () => this.toggleModal('validationModal', false));
        document.getElementById('confirmValidationBtn').addEventListener('click', () => this.confirmValidation());

        // File input
        document.getElementById('fileInput').addEventListener('change', e => {
          if(e.target.files.length > 0) {
            this.loadRealData(e.target.files);
          }
        });
      }

      // ===== FILTER HANDLING =====
      updateFilters() {
        // Terminaciones
        this.filters.terminaciones = Array.from(document.querySelectorAll('#terminacionesOptions .filter-chip.active')).map(el => parseInt(el.dataset.value));

        // Ranges
        ['sum', 'primos', 'sumaDigitos', 'desviacion', 'entropy'].forEach(key => {
            const minInput = document.getElementById(`${key}Min`);
            const maxInput = document.getElementById(`${key}Max`);
            const errorDiv = document.getElementById(`${key}Error`);
            const min = parseFloat(minInput.value);
            const max = parseFloat(maxInput.value);

            if (min > max) {
                minInput.classList.add('error');
                maxInput.classList.add('error');
                if (errorDiv) errorDiv.classList.add('show');
            } else {
                minInput.classList.remove('error');
                maxInput.classList.remove('error');
                if (errorDiv) errorDiv.classList.remove('show');
                this.filters[key] = { min, max };
            }
        });
        
        // Chip options
        ['parImpar', 'bajosAltos', 'consecutivos', 'agrupDecenas'].forEach(key => {
            const containerId = `${key}Options`;
            this.filters[key] = Array.from(document.querySelectorAll(`#${containerId} .filter-chip.active`)).map(el => el.dataset.value);
        });

        // Geometric
        this.filters.geometric.exclude = [];
        this.filters.geometric.favor = [];
        document.querySelectorAll('#geometricOptions .filter-chip.active').forEach(el => {
            const value = el.dataset.value;
            if (el.textContent.includes('🚫')) {
                this.filters.geometric.exclude.push(value);
            } else {
                this.filters.geometric.favor.push(value);
            }
        });

        // AI Switches
        this.filters.useMarkov = document.getElementById('useMarkovSwitch').checked;
        this.filters.useNash = document.getElementById('useNashSwitch').checked;
      }
      
      handleFilterChipClick(chip) {
        chip.classList.toggle('active');
        // For geometric, handle exclude/favor logic if needed
        if (chip.closest('#geometricOptions')) {
            const value = chip.dataset.value;
            if (value === 'espaciados') {
                chip.classList.toggle('favor', chip.classList.contains('active'));
            }
        }
        this.updateFilters();
      }

      // ===== NUMBER SELECTION =====
      handleNumberClick(ball) {
        const number = parseInt(ball.dataset.number);
        if (this.currentSelectionMode === 'excluded') {
          this.excludedNumbers.has(number) ? this.excludedNumbers.delete(number) : this.excludedNumbers.add(number);
          ball.classList.toggle('excluded');
        } else if (this.currentSelectionMode === 'hot') {
          this.hotNumbers.has(number) ? this.hotNumbers.delete(number) : this.hotNumbers.add(number);
          ball.classList.toggle('hot');
        } else if (this.currentSelectionMode === 'cold') {
          this.coldNumbers.has(number) ? this.coldNumbers.delete(number) : this.coldNumbers.add(number);
          ball.classList.toggle('cold');
        } else {
          // Normal selection
          if (this.selectedNumbers.includes(number)) {
            this.removeNumber(number);
          } else {
            const maxNumbers = this.getMaxSelection();
            if (this.selectedNumbers.length < maxNumbers) {
                this.addNumber(number);
            } else {
                this.showToast(`Solo puedes seleccionar hasta ${maxNumbers} números.`, 'warning');
            }
          }
        }
      }
      
      getMaxSelection() {
        const strategy = document.querySelector('.strategy-btn.active').dataset.strategy;
        if (strategy === 'multiple') {
            return parseInt(document.querySelector('.number-option.active').dataset.numbers);
        }
        return 6;
      }

      updateSelectionMode(mode) {
        if(this.currentSelectionMode === mode) {
            // Toggle back to normal selection
            this.currentSelectionMode = null;
            document.querySelectorAll('.selection-mode-btn').forEach(b => b.classList.remove('active'));
            this.showToast('Modo de selección normal activado', 'info');
        } else {
            this.currentSelectionMode = mode;
            document.querySelectorAll('.selection-mode-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.mode === mode);
            });
            this.clearSelections(false);
            const modeText = {
                'hot': 'calientes',
                'cold': 'fríos',
                'excluded': 'excluidos'
            };
            this.showToast(`Modo para marcar números ${modeText[mode]} activado`, 'info');
        }
      }

      addNumber(number) {
        if (!this.selectedNumbers.includes(number)) {
          this.selectedNumbers.push(number);
          this.selectedNumbers.sort((a, b) => a - b);
          document.querySelector(`.number-ball[data-number="${number}"]`).classList.add('selected');
          this.updateSelectedDisplay();
          this.updateStats();
        }
      }

      removeNumber(number) {
        this.selectedNumbers = this.selectedNumbers.filter(n => n !== number);
        document.querySelector(`.number-ball[data-number="${number}"]`).classList.remove('selected');
        this.updateSelectedDisplay();
        this.updateStats();
      }

      updateSelectedDisplay() {
        const display = document.getElementById('selectedDisplay');
        display.innerHTML = '';
        if (this.selectedNumbers.length === 0) {
          display.innerHTML = '<div style="color:#666; font-style: italic;">Selecciona hasta 6 números</div>';
        } else {
          this.selectedNumbers.forEach(num => {
            const ball = document.createElement('div');
            ball.classList.add('number-ball', 'selected');
            ball.style.width = '35px';
            ball.style.height = '35px';
            ball.style.cursor = 'default';
            ball.textContent = num;
            display.appendChild(ball);
          });
        }
        this.updateClearButtonState();
      }

      updateClearButtonState() {
          const clearBtn = document.getElementById('clearBtn');
          const hasSelections = this.selectedNumbers.length > 0 || this.excludedNumbers.size > 0;
          clearBtn.classList.toggle('has-selections', hasSelections);
          if (hasSelections) {
              clearBtn.classList.add('shake');
              setTimeout(() => clearBtn.classList.remove('shake'), 500);
          }
      }

      clearSelections(fullClear = true) {
        this.selectedNumbers = [];
        if(fullClear){
            this.excludedNumbers.clear();
            this.hotNumbers.clear();
            this.coldNumbers.clear();
            this.analyzeNumbers();
        }

        document.querySelectorAll('.number-ball').forEach(ball => {
            ball.classList.remove('selected');
            if(fullClear){
                ball.classList.remove('excluded');
                if (this.hotNumbers.has(parseInt(ball.dataset.number))) ball.classList.add('hot');
                if (this.coldNumbers.has(parseInt(ball.dataset.number))) ball.classList.add('cold');
            }
        });
        
        this.updateSelectedDisplay();
        this.updateStats();
      }

      randomSelect() {
        this.clearSelections(false);
        const availableNumbers = Array.from({ length: 49 }, (_, i) => i + 1)
          .filter(n => !this.excludedNumbers.has(n));
        
        while (this.selectedNumbers.length < 6 && availableNumbers.length > 0) {
          const randomIndex = Math.floor(Math.random() * availableNumbers.length);
          const number = availableNumbers.splice(randomIndex, 1)[0];
          this.addNumber(number);
        }
      }

      // ===== STRATEGY UI =====
      updateStrategyUI(strategy) {
        const winningOptions = document.getElementById('winningOptions');
        const multipleOptions = document.getElementById('multipleNumbersOptions');
        const generateBtnText = document.querySelector('#generateBtn span');
        
        winningOptions.style.display = 'none';
        multipleOptions.style.display = 'none';
        
        if (strategy === 'winning') {
          winningOptions.style.display = 'block';
          generateBtnText.textContent = '🤞 Iniciar Búsqueda Avanzada';
        } else if (strategy === 'multiple') {
          multipleOptions.style.display = 'block';
          generateBtnText.textContent = '🤞 Generar Apuestas Múltiples';
        } else {
          generateBtnText.textContent = '🤞 Generar Combinación';
        }
        this.clearSelections(false);
      }
      
      // ===== GENERATION LOGIC =====
      async generateCombinations() {
        if (this.isGenerating) return;
        
        this.updateFilters();

        const strategy = document.querySelector('.strategy-btn.active').dataset.strategy;

        if (strategy === 'simple' && this.selectedNumbers.length > 6) {
          this.showToast('Para estrategia Simple, selecciona 6 números o menos.', 'error');
          return;
        }

        if (strategy === 'simple' && this.selectedNumbers.length < 6) {
          this.showLoading('Completando y validando combinación...');
          await new Promise(resolve => setTimeout(resolve, 50));
          const baseCombination = [...this.selectedNumbers];
          const needed = 6 - baseCombination.length;
          let attempts = 0;
          let foundCombination = null;

          while (attempts < 50000 && !foundCombination) {
              attempts++;
              document.getElementById('loadingAttempts').textContent = attempts;
              
              const availableNumbers = Array.from({length: 49}, (_, i) => i + 1)
                  .filter(n => !this.excludedNumbers.has(n) && !baseCombination.includes(n));
              
              let combination = [...baseCombination];
              for(let i=0; i<needed; i++){
                  if(availableNumbers.length === 0) break;
                  const randomIndex = Math.floor(Math.random() * availableNumbers.length);
                  combination.push(availableNumbers.splice(randomIndex, 1)[0]);
              }
              
              combination.sort((a,b) => a-b);

              if (this.isValidCombination(combination)) {
                  foundCombination = combination;
              }
          }
          
          this.hideLoading();
          if (foundCombination) {
              this.displayTicket([foundCombination]);
          } else {
              this.showToast('No se encontró combinación válida con los filtros actuales.', 'error');
          }

        } else if (strategy === 'winning') {
            const generateCount = parseInt(document.getElementById('generateCount').value);
            const playCount = parseInt(document.getElementById('playCount').value);
            this.showLoading(`Generando ${generateCount} y seleccionando ${playCount}...`);
            await new Promise(resolve => setTimeout(resolve, 50));

            let validCombinations = [];
            let attempts = 0;
            const maxAttempts = generateCount * 200;

            while(validCombinations.length < generateCount && attempts < maxAttempts) {
                attempts++;
                document.getElementById('loadingAttempts').textContent = attempts;

                const combination = this.generateRandomCombination();
                if (this.isValidCombination(combination)) {
                    const score = this.scoreCombination(combination);
                    validCombinations.push({ combination, score });
                }
            }

            validCombinations.sort((a,b) => b.score - a.score);
            const bestCombinations = validCombinations.slice(0, playCount).map(c => c.combination);
            
            this.hideLoading();
            if (bestCombinations.length > 0) {
                this.displayTicket(bestCombinations);
            } else {
                this.showToast('No se encontraron combinaciones válidas. Relaja los filtros.', 'error');
            }
        } else if (strategy === 'multiple') {
            const numCount = this.getMaxSelection();
            if (this.selectedNumbers.length !== numCount) {
                this.showToast(`Debes seleccionar exactamente ${numCount} números para esta opción.`, 'error');
                return;
            }
            
            this.showLoading('Generando combinaciones múltiples...');
            await new Promise(resolve => setTimeout(resolve, 50));

            const allCombos = this.getCombinations(this.selectedNumbers, 6);
            let validCombos = [];
            let attempts = 0;

            for(const combo of allCombos) {
                attempts++;
                document.getElementById('loadingAttempts').textContent = attempts;
                if (this.isValidCombination(combo)) {
                    validCombos.push(combo);
                }
            }

            this.hideLoading();
            if (validCombos.length > 0) {
                this.displayTicket(validCombos);
            } else {
                this.showToast('Ninguna de las combinaciones múltiples pasó los filtros.', 'error');
            }
        } else { // Strategy Simple con 6 números
             this.showLoading('Validando combinación...');
             await new Promise(resolve => setTimeout(resolve, 50));
             if(this.isValidCombination(this.selectedNumbers)) {
                 this.displayTicket([this.selectedNumbers]);
             } else {
                 this.showToast('La combinación seleccionada no cumple con los filtros.', 'error');
             }
             this.hideLoading();
        }
      }
      
      generateRandomCombination() {
        const combination = new Set();
        const available = Array.from({length: 49}, (_, i) => i + 1).filter(n => !this.excludedNumbers.has(n));
        while(combination.size < 6 && available.length > 0) {
            const index = Math.floor(Math.random() * available.length);
            combination.add(available.splice(index, 1)[0]);
        }
        return Array.from(combination).sort((a,b)=>a-b);
      }
      
      scoreCombination(combination) {
        let score = 0;
        // Nash score
        if (this.filters.useNash) {
            const popularity = combination.reduce((sum, num) => sum + this.popularityMatrix[num], 0);
            score += (1 - popularity) * 100;
        }
        // Markov score
        if (this.filters.useMarkov && this.historicalData.length > 2) {
             const lastTwoDraws = this.historicalData.slice(-2).map(d => d.numbers).flat().sort((a, b) => a - b).join(',');
             if(this.transitionMatrix[lastTwoDraws]) {
                 const prob = combination.reduce((p, num) => p + (this.transitionMatrix[lastTwoDraws][num] || 0), 0);
                 score += prob * 50;
             }
        }
        return score;
      }
      
      isValidCombination(combination) {
        if (combination.length !== 6) return false;

        const stats = this.getCombinationStats(combination);
        
        // Exclusions
        if (this.excludedNumbers.size > 0 && combination.some(n => this.excludedNumbers.has(n))) return false;
        if (this.filters.terminaciones.length > 0 && combination.some(n => this.filters.terminaciones.includes(n % 10))) return false;

        // Basic Filters
        if (stats.sum < this.filters.sum.min || stats.sum > this.filters.sum.max) return false;
        if (!this.filters.parImpar.includes(stats.parImparRatio)) return false;
        if (!this.filters.bajosAltos.includes(stats.bajosAltosRatio)) return false;

        // Structural Filters
        if (stats.primes < this.filters.primos.min || stats.primes > this.filters.primos.max) return false;
        if (!this.filters.consecutivos.includes(stats.consecutiveGroups)) return false;
        if (!this.filters.agrupDecenas.includes(stats.decenasGroups)) return false;
        if (stats.digitSum < this.filters.sumaDigitos.min || stats.digitSum > this.filters.sumaDigitos.max) return false;

        // Advanced Stats Filters
        if (stats.stdDev < this.filters.desviacion.min || stats.stdDev > this.filters.desviacion.max) return false;
        if (stats.entropy < this.filters.entropy.min || stats.entropy > this.filters.entropy.max) return false;

        // Geometric Filters
        if (this.filters.geometric.exclude.length > 0 && this.hasGeometricPattern(combination, this.filters.geometric.exclude)) return false;
        if (this.filters.geometric.favor.length > 0 && !this.hasGeometricPattern(combination, this.filters.geometric.favor)) return false;
        
        return true;
      }
      
       getCombinations(arr, k) {
            const result = [];
            function backtrack(combination, start) {
                if (combination.length === k) {
                    result.push([...combination]);
                    return;
                }
                for (let i = start; i < arr.length; i++) {
                    combination.push(arr[i]);
                    backtrack(combination, i + 1);
                    combination.pop();
                }
            }
            backtrack([], 0);
            return result;
        }

      // ===== STATS & VALIDATION HELPERS =====
      getCombinationStats(combination) {
        const sum = combination.reduce((a, b) => a + b, 0);
        const evens = combination.filter(n => n % 2 === 0).length;
        const lows = combination.filter(n => n <= 25).length;
        const primes = combination.filter(n => this.primes.has(n)).length;
        const digitSum = combination.join('').split('').reduce((a, b) => a + parseInt(b), 0);
        
        // Std Dev
        const mean = sum / 6;
        const stdDev = Math.sqrt(combination.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / 6);
        
        // Decades
        const decades = combination.map(n => Math.floor((n - 1) / 10));
        const decadeCounts = decades.reduce((acc, d) => { acc[d] = (acc[d] || 0) + 1; return acc; }, {});
        
        // Consecutive
        const consecutiveGroups = this.getConsecutiveGroups(combination);

        // Entropy
        const entropy = this.calculateShannonEntropy(combination);

        return {
          sum,
          parImparRatio: `${evens}/${6 - evens}`,
          bajosAltosRatio: `${lows}/${6 - lows}`,
          primes,
          digitSum,
          stdDev: parseFloat(stdDev.toFixed(2)),
          decenas: Object.keys(decadeCounts).length,
          decenasGroups: Object.values(decadeCounts).sort((a,b)=>b-a).join('/'),
          consecutiveGroups,
          entropy: parseFloat(entropy.toFixed(3))
        };
      }
      
      getConsecutiveGroups(numbers) {
        if (numbers.length < 2) return numbers.length.toString();
        let groups = [];
        let currentGroup = 1;
        for (let i = 1; i < numbers.length; i++) {
            if (numbers[i] === numbers[i-1] + 1) {
                currentGroup++;
            } else {
                groups.push(currentGroup);
                currentGroup = 1;
            }
        }
        groups.push(currentGroup);
        return groups.sort((a,b) => b-a).join('/');
      }

      calculateShannonEntropy(combination) {
        const coords = combination.map(n => this.geometricMatrix[n]);
        const distances = [];
        for (let i = 0; i < coords.length; i++) {
            for (let j = i + 1; j < coords.length; j++) {
                distances.push(Math.sqrt(Math.pow(coords[i].x - coords[j].x, 2) + Math.pow(coords[i].y - coords[j].y, 2)));
            }
        }
        const totalDist = distances.reduce((a, b) => a + b, 0);
        if (totalDist === 0) return 0;

        let entropy = 0;
        for (const dist of distances) {
            const p = dist / totalDist;
            if (p > 0) {
                entropy -= p * Math.log2(p);
            }
        }
        return entropy;
      }
      
      hasGeometricPattern(combination, patterns) {
        const coords = combination.map(n => this.geometricMatrix[n]);

        for(const pattern of patterns) {
            if (pattern === 'lineas' && this.isCollinear(coords, 3)) return true;
            if (pattern === 'diagonales' && this.isDiagonal(coords, 3)) return true;
            if (pattern === 'cruces' && this.formsCross(coords)) return true;
            if (pattern === 'espaciados' && this.isWellSpaced(coords)) return true;
        }
        return false;
      }
      
      isCollinear(coords, minPoints) {
          if (coords.length < minPoints) return false;
          for (let i = 0; i < coords.length; i++) {
              for (let j = i + 1; j < coords.length; j++) {
                  let collinearCount = 2;
                  for (let k = j + 1; k < coords.length; k++) {
                      const val = (coords[j].y - coords[i].y) * (coords[k].x - coords[j].x) -
                                  (coords[j].x - coords[i].x) * (coords[k].y - coords[j].y);
                      if (Math.abs(val) < 1e-9) {
                          collinearCount++;
                      }
                  }
                  if (collinearCount >= minPoints) return true;
              }
          }
          return false;
      }

      isDiagonal(coords, minPoints) {
          const mainDiagonals = new Map();
          const antiDiagonals = new Map();
          coords.forEach(c => {
              const mainD = c.y - c.x;
              const antiD = c.y + c.x;
              mainDiagonals.set(mainD, (mainDiagonals.get(mainD) || 0) + 1);
              antiDiagonals.set(antiD, (antiDiagonals.get(antiD) || 0) + 1);
          });
          return Array.from(mainDiagonals.values()).some(c => c >= minPoints) || 
                 Array.from(antiDiagonals.values()).some(c => c >= minPoints);
      }

      formsCross(coords) {
         for(const center of coords) {
             const hasHorizontal = coords.some(p => p.y === center.y && Math.abs(p.x - center.x) === 1);
             const hasVertical = coords.some(p => p.x === center.x && Math.abs(p.y - center.y) === 1);
             if(hasHorizontal && hasVertical) return true;
         }
         return false;
      }
      
      isWellSpaced(coords) {
          let minDist = Infinity;
          for(let i=0; i < coords.length; i++) {
              for(let j=i+1; j < coords.length; j++) {
                  const dist = Math.sqrt(Math.pow(coords[i].x - coords[j].x, 2) + Math.pow(coords[i].y - coords[j].y, 2));
                  minDist = Math.min(minDist, dist);
              }
          }
          return minDist > 1.5; // Threshold for spacing
      }

      updateStats() {
        if (this.selectedNumbers.length !== 6) {
          document.querySelectorAll('.stats-grid .stat-value').forEach(el => el.textContent = '-');
          return;
        }

        const stats = this.getCombinationStats(this.selectedNumbers);
        const filterStatus = {
            sum: stats.sum >= this.filters.sum.min && stats.sum <= this.filters.sum.max,
            parImpar: this.filters.parImpar.includes(stats.parImparRatio),
            bajosAltos: this.filters.bajosAltos.includes(stats.bajosAltosRatio),
            primos: stats.primes >= this.filters.primos.min && stats.primes <= this.filters.primos.max,
            consecutivos: this.filters.consecutivos.includes(stats.consecutiveGroups),
            sumaDigitos: stats.digitSum >= this.filters.sumaDigitos.min && stats.digitSum <= this.filters.sumaDigitos.max,
            desviacion: stats.stdDev >= this.filters.desviacion.min && stats.stdDev <= this.filters.desviacion.max,
            entropia: stats.entropy >= this.filters.entropy.min && stats.entropy <= this.filters.entropy.max,
            agrupDecenas: this.filters.agrupDecenas.includes(stats.decenasGroups)
        };
        
        const setStat = (id, value, valid) => {
            const el = document.getElementById(id);
            el.textContent = value;
            el.classList.toggle('valid', valid);
            el.classList.toggle('invalid', !valid);
        };
        
        setStat('statSuma', stats.sum, filterStatus.sum);
        setStat('statParImpar', stats.parImparRatio, filterStatus.parImpar);
        setStat('statBajosAltos', stats.bajosAltosRatio, filterStatus.bajosAltos);
        setStat('statDecenas', stats.decenas, true);
        setStat('statAgrupDecenas', stats.decenasGroups, filterStatus.agrupDecenas);
        setStat('statConsecutivos', stats.consecutiveGroups, filterStatus.consecutivos);
        setStat('statSumaDigitos', stats.digitSum, filterStatus.sumaDigitos);
        setStat('statPrimos', stats.primes, filterStatus.primos);
        setStat('statDesviacion', stats.stdDev, filterStatus.desviacion);
        setStat('statEntropia', stats.entropy, filterStatus.entropia);
      }
      

      // ===== TICKET & STORAGE =====
      displayTicket(combinations) {
        this.currentTicket = {
            date: new Date().toISOString(),
            combinations: combinations
        };
        const ticketDiv = document.getElementById('ticket');
        const combinationsDiv = document.getElementById('ticketCombinations');
        document.getElementById('ticketDate').textContent = new Date().toLocaleString();
        combinationsDiv.innerHTML = '';

        combinations.forEach(combo => {
            const comboDiv = document.createElement('div');
            comboDiv.className = 'ticket-combination';
            combo.forEach(num => {
                const numDiv = document.createElement('div');
                numDiv.className = 'ticket-number';
                numDiv.textContent = num;
                comboDiv.appendChild(numDiv);
            });
            combinationsDiv.appendChild(comboDiv);
        });
        
        ticketDiv.classList.add('show');
      }

      saveTicket() {
        if (!this.currentTicket) return;
        this.savedTickets.unshift(this.currentTicket);
        if (this.platform === 'appinventor') {
            if (typeof window.AppInventor !== 'undefined') {
                window.AppInventor.setWebViewString(JSON.stringify({
                    action: 'SAVE_TICKETS',
                    tickets: this.savedTickets
                }));
            }
        } else {
            localStorage.setItem('lotto49_tickets', JSON.stringify(this.savedTickets));
            this.showToast('✅ Boleto guardado localmente', 'success');
        }
        this.updateSavedTickets();
        this.currentTicket = null;
        document.getElementById('ticket').classList.remove('show');
      }

      loadTickets() {
        if (this.platform === 'web') {
            const tickets = localStorage.getItem('lotto49_tickets');
            this.savedTickets = tickets ? JSON.parse(tickets) : [];
            this.updateSavedTickets();
        }
      }

      deleteTicket(date) {
        this.savedTickets = this.savedTickets.filter(ticket => ticket.date !== date);
         if (this.platform === 'appinventor') {
            if (typeof window.AppInventor !== 'undefined') {
                window.AppInventor.setWebViewString(JSON.stringify({
                    action: 'SAVE_TICKETS',
                    tickets: this.savedTickets
                }));
            }
        } else {
            localStorage.setItem('lotto49_tickets', JSON.stringify(this.savedTickets));
        }
        this.updateSavedTickets();
        this.showToast('Boleto eliminado', 'info');
      }
      
      updateSavedTickets() {
        const container = document.getElementById('savedTickets');
        container.innerHTML = '';
        if (this.savedTickets.length === 0) {
          container.innerHTML = '<div style="color:#666; text-align: center; padding: 20px;">No tienes boletos guardados</div>';
          return;
        }

        this.savedTickets.forEach(ticket => {
          const item = document.createElement('div');
          item.className = 'saved-ticket-item';
          
          let combinationsHTML = '';
          ticket.combinations.forEach(combo => {
              combinationsHTML += `<div class="saved-combination"><div class="saved-combination-content">${combo.map(n => `<div class="saved-combination-number">${n}</div>`).join('')}</div></div>`;
          });

          item.innerHTML = `
            <div class="saved-ticket-header">
              <span class="saved-ticket-date">${new Date(ticket.date).toLocaleString()}</span>
              <div class="saved-ticket-actions">
                <button class="validate">Validar</button>
                <button class="delete-btn">X</button>
                <button class="toggle-btn">+</button>
              </div>
            </div>
            <div class="saved-combinations">${combinationsHTML}</div>
          `;

          item.querySelector('.delete-btn').addEventListener('click', () => this.deleteTicket(ticket.date));
          item.querySelector('.validate').addEventListener('click', () => this.startValidation(ticket.date));
          item.querySelector('.toggle-btn').addEventListener('click', (e) => {
              const comboDiv = item.querySelector('.saved-combinations');
              const isVisible = comboDiv.style.display === 'block';
              comboDiv.style.display = isVisible ? 'none' : 'block';
              e.target.textContent = isVisible ? '+' : '-';
          });

          container.appendChild(item);
        });
      }
      
      startValidation(date) {
        this.currentValidatingTicket = this.savedTickets.find(t => t.date === date);
        document.getElementById('validationResults').innerHTML = '';
        document.getElementById('winningNumbersInput').value = '';
        this.toggleModal('validationModal', true);
      }
      
      confirmValidation() {
        const input = document.getElementById('winningNumbersInput').value;
        const winningNumbers = new Set(input.split(/[ ,.]+/).map(n => parseInt(n)).filter(n => !isNaN(n) && n > 0 && n < 50));

        if (winningNumbers.size !== 6) {
          this.showToast('Introduce 6 números ganadores válidos.', 'error');
          return;
        }

        const resultsDiv = document.getElementById('validationResults');
        resultsDiv.innerHTML = '';

        this.currentValidatingTicket.combinations.forEach(combo => {
            const hits = combo.filter(n => winningNumbers.has(n)).length;
            const resultItem = document.createElement('div');
            resultItem.className = 'saved-combination';
            resultItem.innerHTML = `
                <div class="saved-combination-content">${combo.map(n => `<div class="saved-combination-number ${winningNumbers.has(n) ? 'selected' : ''}">${n}</div>`).join('')}</div>
                <div class="hit-count">${hits} aciertos</div>
            `;
            resultsDiv.appendChild(resultItem);
        });
      }
      
      shareTicket() {
          if (!this.currentTicket) return;
          const text = `Mi boleto DataLotto49:\n${this.currentTicket.combinations.map(c => c.join(' - ')).join('\n')}`;
          if (navigator.share) {
              navigator.share({
                  title: 'Mi Boleto DataLotto49',
                  text: text,
              }).catch(console.error);
          } else {
              navigator.clipboard.writeText(text).then(() => {
                  this.showToast('Boleto copiado al portapapeles', 'success');
              });
          }
      }

      // ===== UI HELPERS =====
      showLoading(text = 'Generando combinación...') {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingAttempts').textContent = '0';
        document.getElementById('loadingModal').style.display = 'flex';
        this.isGenerating = true;
      }

      hideLoading() {
        document.getElementById('loadingModal').style.display = 'none';
        this.isGenerating = false;
      }

      showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => {
          toast.className = 'toast';
        }, 3000);
      }
      
      toggleModal(id, show) {
        document.getElementById(id).style.display = show ? 'flex' : 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.app = new DataLotto49Advanced();
    });
  </script>
</body>
</html>
