<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>üé≤ DataLotto49 Mobile</title>

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --danger-light: #fca5a5;
      --warning: #f59e0b;
      --info: #06b6d4;
      --dark: #1f2937;
      --light: #f9fafb;
      --gray: #6b7280;
      --border-radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    input, textarea {
      -webkit-user-select: text;
      -khtml-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    html {
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      scroll-behavior: smooth;
      overflow-x: hidden;
      overflow-y: auto;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      color: var(--dark);
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 0 5px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      position: relative;
    }

    .header h1 {
      color: var(--primary);
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      color: var(--gray);
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
    }

    .disclaimer-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 32px;
      height: 32px;
      border: 2px solid var(--warning);
      background: var(--warning);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      animation: disclaimerPulse 2s infinite;
    }

    .disclaimer-btn:hover {
      background: #e68900;
      border-color: #e68900;
      transform: scale(1.1);
    }

    @keyframes disclaimerPulse {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
      }
      50% { 
        box-shadow: 0 0 0 8px rgba(245, 158, 11, 0);
      }
    }

    .selected-numbers {
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
    }

    .selected-numbers h3 {
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-align: center;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .selected-display {
      min-height: 50px;
      border: 2px dashed #e5e7eb;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }

    .number-selection-section {
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
    }

    .number-selection-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    .number-selection-header h3 {
      color: var(--primary);
      text-align: center;
      margin: 0;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .selection-mode-controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .selection-mode-btn {
      width: 42px;
      height: 42px;
      border: 3px solid;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: clamp(1.1rem, 3vw, 1.4rem);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      background: #f5f5f5;
    }

    .selection-mode-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .selection-mode-btn[data-mode="cold"] {
      border-color: #2196f3;
      background: #e3f2fd;
      color: #1976d2;
    }

    .selection-mode-btn[data-mode="hot"] {
      border-color: #f44336;
      background: #ffebee;
      color: #d32f2f;
    }

    .selection-mode-btn[data-mode="excluded"] {
      border-color: #9e9e9e;
      background: #f5f5f5;
      color: #616161;
    }

    .selection-mode-btn[data-mode="data"] {
      border-color: #4caf50;
      background: #e8f5e8;
      color: #2e7d32;
    }

    .selection-mode-btn[data-mode="simulate"] {
      border-color: #ff9800;
      background: #fff3e0;
      color: #f57c00;
    }

    .selection-mode-btn.active {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      animation: pulse-selection 2s infinite;
    }

    .selection-mode-btn.active[data-mode="cold"] {
      border-color: #1976d2;
      background: #2196f3;
      color: white;
      box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
    }

    .selection-mode-btn.active[data-mode="hot"] {
      border-color: #d32f2f;
      background: #f44336;
      color: white;
      box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
    }

    .selection-mode-btn.active[data-mode="excluded"] {
      border-color: #616161;
      background: #9e9e9e;
      color: white;
      box-shadow: 0 8px 25px rgba(158, 158, 158, 0.4);
    }

    .selection-mode-btn.active[data-mode="data"] {
      border-color: #2e7d32;
      background: #4caf50;
      color: white;
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
    }

    .selection-mode-btn.active[data-mode="simulate"] {
      border-color: #f57c00;
      background: #ff9800;
      color: white;
      box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
    }

    @keyframes pulse-selection {
      0%, 100% { transform: scale(1.1); }
      50% { transform: scale(1.2); }
    }

    #randomBtn:hover {
      transform: rotate(360deg) scale(1.05);
    }

    #clearBtn {
      transition: all 0.3s ease;
      border-color: #9e9e9e;
      background: #f5f5f5;
      color: #616161;
    }

    #clearBtn:hover {
      transform: scale(1.1);
    }

    #clearBtn.has-selections {
      background: var(--danger-light);
      border-color: var(--danger-light);
      color: white;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
      20%, 40%, 60%, 80% { transform: translateX(2px); }
    }

    #clearBtn.shake {
      animation: shake 0.5s ease-in-out;
    }

    .numbers-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      max-width: 100%;
      margin: 0 auto;
    }

    @media(min-width: 480px) {
      .numbers-grid {
        gap: 6px;
      }
    }

    .number-ball {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid #e0e0e0;
      background: linear-gradient(135deg, #fafafa, #f0f0f0);
      position: relative;
      font-size: clamp(0.7rem, 2.5vw, 1rem);
      min-height: 35px;
    }

    .number-ball:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1.05); }
      50% { transform: scale(1.15); }
    }

    .number-ball.selected {
      background: linear-gradient(135deg, #ffd700, #ffa000);
      border-color: #ff8f00;
      color: white;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(255,193,7,0.4);
      animation: pulse 1.5s infinite;
    }
    
    .number-ball.generated-pick,
    .number-ball.random-pick {
        transform: scale(1.05);
        animation: pulse 1.5s infinite;
    }

    .number-ball.generated-pick {
      background: linear-gradient(135deg, #9333ea, #c084fc);
      color: white;
      border-color: #7c3aed;
      box-shadow: 0 0 15px rgba(147, 51, 234, 0.4);
    }

    .number-ball.random-pick {
      background: var(--warning);
      color: white;
      border-color: #e68900;
      box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
    }

    .number-ball.hot {
      border-color: #ff5722;
      background: linear-gradient(135deg, #ffebee, #ffcdd2);
      color: #d32f2f;
      box-shadow: 0 0 10px rgba(255, 87, 34, 0.3);
    }

    .number-ball.cold {
      border-color: #03a9f4;
      background: linear-gradient(135deg, #e1f5fe, #b3e5fc);
      color: #0277bd;
      box-shadow: 0 0 10px rgba(3, 169, 244, 0.3);
    }

    .number-ball.excluded {
      background: #757575;
      border-color: #424242;
      color: white;
      opacity: 0.6;
      cursor: not-allowed;
    }

    .number-ball .number-icon {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border: 1px solid white;
      background: var(--gray);
      color: white;
      text-shadow: 0 0 2px rgba(0,0,0,0.5);
      line-height: 16px;
    }
    
    .number-ball .number-icon:empty {
      display: none;
    }

    .number-ball.hot .number-icon { background: #ff5722; }
    .number-ball.cold .number-icon { background: #03a9f4; }
    .number-ball.excluded .number-icon { background: #9e9e9e; }
    .number-ball.random-pick .number-icon { background: var(--warning); }
    .number-ball.generated-pick .number-icon { background: #7c3aed; }


    /* SECCIONES COLAPSABLES */
    .collapsible-section {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
      overflow: hidden;
    }

    .collapsible-header {
      padding: 15px;
      background: var(--light);
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .collapsible-header:hover {
      background: #f3f4f6;
    }

    .collapsible-header h3 {
      color: var(--primary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .collapse-btn {
      width: 30px;
      height: 30px;
      border: none;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .collapse-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }

    .collapse-btn.collapsed {
      transform: rotate(0deg);
    }

    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .collapsible-content.expanded {
      max-height: 2000px;
      transition: max-height 0.5s ease-in;
    }

    .collapsible-inner {
      padding: 15px;
    }

    .data-analysis-section {
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
    }

    .data-analysis-section h3 {
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .data-info {
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      color: var(--gray);
      text-align: center;
    }

    .data-info.has-data {
      background: #e8f5e8;
      color: var(--success);
      font-weight: bold;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    @media(max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-item {
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--gray);
      margin-bottom: 3px;
    }

    .stat-value {
      font-weight: bold;
      color: var(--dark);
      font-size: 0.9rem;
    }

    .stat-value.valid {
      color: #4caf50;
      text-shadow: 0 0 10px rgba(76,175,80,0.3);
    }

    .stat-value.invalid {
      color: var(--danger);
    }

    .strategy-section {
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
    }

    .strategy-section h3 {
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .strategy-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    @media(max-width: 480px) {
      .strategy-buttons {
        grid-template-columns: 1fr;
      }
    }

    .strategy-btn {
      padding: 12px 8px;
      background: #f3f4f6;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
      font-size: 0.9rem;
    }

    .strategy-btn:hover {
      transform: translateY(-2px);
      border-color: var(--primary);
    }

    .strategy-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .input-row label {
      font-weight: bold;
      color: var(--dark);
      min-width: 60px;
      font-size: 0.9rem;
    }

    .input-row input {
      width: 70px;
      padding: 6px 10px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .input-row input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .input-row span {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .number-option {
      padding: 8px;
      background: #f3f4f6;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .number-option:hover {
      background: var(--primary);
      color: white;
    }

    .number-option.active {
      background: var(--primary);
      color: white;
    }

    .generate-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      font-size: clamp(1rem, 3vw, 1.1rem);
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      animation: generatePulse 2s infinite;
    }

    .generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    @keyframes generatePulse {
      0%, 100% { 
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
      }
      50% { 
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
      }
    }

    .ticket {
      background: linear-gradient(135deg, #fff8e1, #ffecb3);
      border: 2px dashed #ff9800;
      border-radius: 15px;
      padding: 15px;
      margin-top: 15px;
      display: none;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      0% { transform: translateY(20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    .ticket.show {
      display: block;
    }

    .ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e5e7eb;
      text-align: center;
      color: #e65100;
      flex-wrap: wrap;
    }

    .ticket-header h4 {
      color: var(--primary);
      font-size: clamp(1rem, 3vw, 1.1rem);
    }

    .ticket-header p {
      color: var(--gray);
      font-size: clamp(0.8rem, 2vw, 0.9rem);
    }

    .ticket-combination {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: white;
      border-radius: 10px;
      margin-bottom: 8px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: clamp(0.8rem, 2.5vw, 1rem);
    }

    .ticket-number {
      width: 25px;
      height: 25px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(0.7rem, 2vw, 0.9rem);
      flex-shrink: 0;
    }

    .ticket-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .ticket-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: var(--transition);
      font-size: 0.9rem;
    }

    .ticket-btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .save-btn {
      background: linear-gradient(135deg, #2196f3, #1976d2);
      color: white;
    }

    .share-btn {
      background: linear-gradient(135deg, #4caf50, #388e3c);
      color: white;
    }

    .ticket-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    .filter-group {
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
      margin-bottom: 10px;
      transition: var(--transition);
    }

    .filter-group.active {
      background: #f7f3ff;
      border-left-color: var(--secondary);
    }

    .filter-title {
      font-weight: bold;
      color: var(--dark);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .range-control {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .range-control input {
      width: 70px;
      padding: 6px 10px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .range-control input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .range-control input.error {
      border-color: var(--danger);
      background-color: #fef2f2;
    }

    .range-control span {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .filter-chip {
      padding: 6px 12px;
      background: #f3f4f6;
      border-radius: 15px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
    }

    .filter-chip:hover {
      border-color: var(--primary);
    }

    .filter-chip.active {
      border-color: #4caf50;
      background: #e8f5e8;
      color: #2e7d32;
    }
    
    .filter-chip.favor {
      border-color: var(--info);
      background: #e0f7fa;
      color: #006064;
    }
    
    .switch-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    .filter-info-text {
        font-size: 0.8rem;
        color: var(--gray);
        margin-top: 8px;
        padding: 8px;
        background-color: #f3f4f6;
        border-radius: 6px;
    }

    .validation-error {
      background: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.8rem;
      margin-top: 5px;
      display: none;
    }

    .validation-error.show {
      display: block;
    }

    .saved-tickets-section {
      background: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 80px;
    }

    .saved-tickets-section h3 {
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .saved-tickets {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .saved-ticket-item {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
    }

    .saved-ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .saved-ticket-date {
      font-weight: bold;
      color: var(--dark);
      font-size: clamp(0.8rem, 2.5vw, 0.95rem);
    }
    
    .saved-ticket-strategy {
        font-size: 0.8rem;
        font-weight: bold;
        color: var(--primary);
        background-color: #f7f3ff;
        padding: 3px 8px;
        border-radius: 12px;
    }

    .saved-ticket-actions {
      display: flex;
      gap: 8px;
    }

    .validate {
      background: var(--success);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .delete-btn {
      background: var(--danger) !important;
      color: white !important;
      border: none;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      transition: var(--transition);
    }

    .delete-btn:hover {
      background: #dc2626 !important;
      transform: scale(1.05);
    }

    .toggle-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .saved-combinations {
      margin-top: 8px;
      padding: 8px;
      background: #f9fafb;
      border-radius: 6px;
      display: none;
    }

    .saved-combination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px;
      background: white;
      border-radius: 4px;
      margin-bottom: 4px;
    }

    .hit-count {
      font-size: 0.8rem;
      font-weight: bold;
      color: var(--success);
      background-color: #e8f9f1;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .saved-combination-number {
      width: 18px;
      height: 18px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    .saved-combination-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Loading */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .loading-content {
      background: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      max-width: 90%;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f4f6;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #loadingInfo {
        margin-top: 10px;
        color: var(--gray);
        font-size: 0.9rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 15px;
      width: 95%;
      max-width: 400px;
      max-height: 80vh;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      margin-bottom: 15px;
      flex-shrink: 0;
    }

    .modal-header h3 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .modal-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 15px;
      flex-shrink: 0;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    #validationResults {
      flex: 1;
      overflow-y: auto;
      max-height: 200px;
      margin-bottom: 15px;
      padding-right: 5px;
    }

    #validationResults::-webkit-scrollbar {
      width: 6px;
    }

    #validationResults::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    #validationResults::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    #validationResults::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-shrink: 0;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .modal-btn.cancel {
      background: #f3f4f6;
      color: var(--dark);
    }

    .modal-btn.confirm {
      background: var(--success);
      color: white;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      opacity: 0;
      transform: translateX(-50%) translateY(20px);
      transition: all 0.3s ease;
      max-width: 90%;
      text-align: center;
      font-size: 0.9rem;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
    }

    .hidden-file-input {
      display: none;
    }

    @media(max-width: 320px) {
      .numbers-grid {
        gap: 2px;
      }

      .number-ball {
        min-height: 30px;
        font-size: 0.6rem;
      }

      .selection-mode-btn {
        width: 38px;
        height: 38px;
        font-size: 1rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1>üé≤ DataLotto49</h1>
      <p>Generador Inteligente con Arquitectura Matem√°tica Avanzada</p>
      <button class="disclaimer-btn" id="disclaimerBtn" title="Disclaimer √âtico">‚ö†Ô∏è</button>
    </header>

    <div class="selected-numbers">
      <h3>üéØ N√∫meros Seleccionados</h3>
      <div class="selected-display" id="selectedDisplay">
        <div style="color:#666; font-style: italic;">Selecciona hasta 6 n√∫meros</div>
      </div>
    </div>

    <div class="number-selection-section">
      <div class="number-selection-header">
        <h3>Selecci√≥n de n√∫meros</h3>
        <div class="selection-mode-controls">
          <button class="selection-mode-btn" data-mode="cold" title="Activar modo para marcar/desmarcar n√∫meros fr√≠os">
            <span class="icon">‚ùÑÔ∏è</span>
          </button>
          <button class="selection-mode-btn" data-mode="hot" title="Activar modo para marcar/desmarcar n√∫meros calientes">
            <span class="icon">üî•</span>
          </button>
          <button class="selection-mode-btn" data-mode="excluded" title="Activar modo para marcar/desmarcar n√∫meros excluidos">
            <span class="icon">üö´</span>
          </button>
          <button class="selection-mode-btn" data-mode="data" title="Cargar base de datos" id="dataBtn">
            <span class="icon">üìä</span>
          </button>
          <button class="selection-mode-btn" id="urlBtn" title="Cargar datos desde URL" style="border-color: #673ab7; background: #ede7f6; color: #512da8;">
            <span class="icon">üîó</span>
          </button>
          <button class="selection-mode-btn" data-mode="simulate" title="Simular datos" id="simulateBtn">
            <span class="icon">üé∞</span>
          </button>
          <button class="selection-mode-btn" id="randomBtn" title="Seleccionar 6 n√∫meros al azar">
            <span class="icon">üé≤</span>
          </button>
          <button class="selection-mode-btn" id="clearBtn" title="Limpiar todas las selecciones">
            <span class="icon">üóëÔ∏è</span>
          </button>
        </div>
      </div>

      <div class="numbers-grid" id="numbersGrid"></div>
    </div>

    <!-- Analizador Estad√≠stico -->
    <div class="data-analysis-section">
      <h3>üìä Analizador Estad√≠stico Base</h3>
      <div class="data-info" id="dataInfo">
        No hay datos cargados. Carga una base de datos CSV/DB o simula datos hist√≥ricos.
      </div>
      <div class="stats-grid" id="dataStatsGrid" style="display: none;">
        <div class="stat-item">
          <div class="stat-label">Total Sorteos</div>
          <div class="stat-value" id="totalDraws">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Tipo de Datos</div>
          <div class="stat-value" id="dataType">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">N√∫meros M√°s Frecuentes</div>
          <div class="stat-value" id="mostFrequent">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">N√∫meros Menos Frecuentes</div>
          <div class="stat-value" id="leastFrequent">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Chi-cuadrado (Estad√≠stico)</div>
          <div class="stat-value" id="chiSquare">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Sesgo Detectado</div>
          <div class="stat-value" id="biasDetected">-</div>
        </div>
      </div>
    </div>

    <!-- Estad√≠sticas Colapsables -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="stats">
        <h3>üìä Estad√≠sticas en Tiempo Real</h3>
        <button class="collapse-btn collapsed" id="statsCollapseBtn">+</button>
      </div>
      <div class="collapsible-content" id="statsContent">
        <div class="collapsible-inner">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">Suma Total</div>
              <div class="stat-value" id="statSuma">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Par/Impar</div>
              <div class="stat-value" id="statParImpar">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Bajos/Altos</div>
              <div class="stat-value" id="statBajosAltos">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Decenas</div>
              <div class="stat-value" id="statDecenas">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Agrup. Decenas</div>
              <div class="stat-value" id="statAgrupDecenas">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Consecutivos</div>
              <div class="stat-value" id="statConsecutivos">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Suma D√≠gitos</div>
              <div class="stat-value" id="statSumaDigitos">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">N√∫meros Primos</div>
              <div class="stat-value" id="statPrimos">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Desviaci√≥n</div>
              <div class="stat-value" id="statDesviacion">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Entrop√≠a</div>
              <div class="stat-value" id="statEntropia">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="strategy-section">
      <h3>‚ôü Estrategia de Juego</h3>
      <div class="strategy-buttons">
        <div class="strategy-btn active" data-strategy="simple">
          <div style="font-size: 1.5rem; margin-bottom: 5px;">üéØ</div>
          <div>Simple</div>
        </div>
        <div class="strategy-btn" data-strategy="winning">
          <div style="font-size: 1.5rem; margin-bottom: 5px;">üèÜ</div>
          <div>Estrategia Ganadora</div>
        </div>
        <div class="strategy-btn" data-strategy="multiple">
          <div style="font-size: 1.5rem; margin-bottom: 5px;">üé∞</div>
          <div>M√∫ltiple</div>
        </div>
      </div>

      <div class="multiple-options" id="winningOptions" style="display: none;">
        <div class="input-row">
          <label>Generar:</label>
          <input type="number" id="generateCount" value="100" min="10" max="1000">
          <span>combinaciones</span>
        </div>
        <div class="input-row">
          <label>Jugar:</label>
          <input type="number" id="playCount" value="10" min="1" max="100">
          <span>mejores</span>
        </div>
      </div>

      <div class="multiple-numbers-options" id="multipleNumbersOptions" style="display: none;">
        <div class="numbers-select">
          <label>¬øCu√°ntos n√∫meros quieres seleccionar?</label>
          <div class="number-option active" data-numbers="7">7 n√∫meros</div>
          <div class="number-option" data-numbers="8">8 n√∫meros</div>
          <div class="number-option" data-numbers="9">9 n√∫meros</div>
          <div class="number-option" data-numbers="10">10 n√∫meros</div>
          <div class="number-option" data-numbers="11">11 n√∫meros</div>
        </div>
      </div>

      <button class="generate-btn" id="generateBtn"><span>ü§û Generar Combinaci√≥n</span></button>

      <div class="ticket" id="ticket">
        <div class="ticket-header">
          <h4>üé´ Tu Boleto Ganador</h4>
          <p id="ticketDate"></p>
        </div>
        <div id="ticketCombinations"></div>
        <div class="ticket-actions">
          <button class="ticket-btn save-btn" id="saveBtn"><span>üíæ Guardar Boleto</span></button>
          <button class="ticket-btn share-btn" id="shareBtn"><span>üì§ Compartir</span></button>
        </div>
      </div>
    </div>

    <!-- Filtros Matem√°ticos Jer√°rquicos Colapsables -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="filters">
        <h3>‚öôÔ∏è Panel de Control de Filtros Avanzados</h3>
        <button class="collapse-btn collapsed" id="filtersCollapseBtn">+</button>
      </div>
      <div class="collapsible-content" id="filtersContent">
        <div class="collapsible-inner">
          <div class="filters-panel">
            <!-- GRUPO: Excluir Terminaciones -->
            <div class="filter-group" title="Excluye cualquier combinaci√≥n que contenga un n√∫mero terminado en los d√≠gitos seleccionados. Por ejemplo, si seleccionas '7', se excluir√°n los n√∫meros 7, 17, 27, 37, 47.">
              <div class="filter-title">üö´ Excluir Terminaciones</div>
              <div class="filter-options" id="terminacionesOptions">
                <div class="filter-chip" data-value="0">0</div>
                <div class="filter-chip" data-value="1">1</div>
                <div class="filter-chip" data-value="2">2</div>
                <div class="filter-chip" data-value="3">3</div>
                <div class="filter-chip" data-value="4">4</div>
                <div class="filter-chip" data-value="5">5</div>
                <div class="filter-chip" data-value="6">6</div>
                <div class="filter-chip" data-value="7">7</div>
                <div class="filter-chip" data-value="8">8</div>
                <div class="filter-chip" data-value="9">9</div>
              </div>
            </div>

            <!-- GRUPO: Filtros de Balance -->
            <div class="filter-group" title="La suma de los 6 n√∫meros. Estad√≠sticamente, la mayor√≠a de los sorteos ganadores suman entre 121 y 190.">
              <div class="filter-title">üéØ Suma Total</div>
              <div class="range-control">
                <input type="number" id="sumMin" value="121" min="21" max="279">
                <span>a</span>
                <input type="number" id="sumMax" value="190" min="21" max="279">
              </div>
              <div class="validation-error" id="sumError">El valor m√≠nimo no puede ser mayor que el m√°ximo</div>
            </div>

            <div class="filter-group" title="Proporci√≥n de n√∫meros pares e impares. Las proporciones 4/2, 3/3 y 2/4 son las m√°s comunes.">
              <div class="filter-title">‚öñÔ∏è Par/Impar</div>
              <div class="filter-options" id="parImparOptions">
                <div class="filter-chip" data-value="6/0">6P/0I</div>
                <div class="filter-chip" data-value="5/1">5P/1I</div>
                <div class="filter-chip active" data-value="4/2">4P/2I</div>
                <div class="filter-chip active" data-value="3/3">3P/3I</div>
                <div class="filter-chip active" data-value="2/4">2P/4I</div>
                <div class="filter-chip" data-value="1/5">1P/5I</div>
                <div class="filter-chip" data-value="0/6">0P/6I</div>
              </div>
            </div>

            <div class="filter-group" title="Proporci√≥n de n√∫meros bajos (1-25) y altos (26-49). Proporciones equilibradas como 3/3, 4/2 y 2/4 son frecuentes.">
              <div class="filter-title">üìä Bajos/Altos</div>
              <div class="filter-options" id="bajosAltosOptions">
                <div class="filter-chip" data-value="6/0">6B/0A</div>
                <div class="filter-chip" data-value="5/1">5B/1A</div>
                <div class="filter-chip active" data-value="4/2">4B/2A</div>
                <div class="filter-chip active" data-value="3/3">3B/3A</div>
                <div class="filter-chip active" data-value="2/4">2B/4A</div>
                <div class="filter-chip" data-value="1/5">1B/5A</div>
                <div class="filter-chip" data-value="0/6">0B/6A</div>
              </div>
            </div>

            <!-- GRUPO: Filtros Estructurales -->
             <div class="filter-group" title="Cantidad de n√∫meros primos (2, 3, 5, 7...). Generalmente, hay entre 1 y 3 primos en un sorteo.">
              <div class="filter-title">üî¢ N√∫meros Primos</div>
              <div class="range-control">
                <span>Entre</span>
                <input type="number" id="primosMin" value="1" min="0" max="6">
                <span>y</span>
                <input type="number" id="primosMax" value="3" min="0" max="6">
                <span>primos</span>
              </div>
              <div class="validation-error" id="primosError">El valor m√≠nimo no puede ser mayor que el m√°ximo</div>
            </div>
            
            <div class="filter-group" title="Agrupaci√≥n de n√∫meros consecutivos. '1/1/1/1/1/1' significa que no hay consecutivos.">
              <div class="filter-title">üîó N√∫meros Consecutivos</div>
              <div class="filter-options" id="consecutivosOptions">
                <div class="filter-chip" data-value="6">6</div>
                <div class="filter-chip" data-value="5/1">5/1</div>
                <div class="filter-chip" data-value="4/2">4/2</div>
                <div class="filter-chip" data-value="4/1/1">4/1/1</div>
                <div class="filter-chip" data-value="3/3">3/3</div>
                <div class="filter-chip" data-value="3/2/1">3/2/1</div>
                <div class="filter-chip" data-value="3/1/1/1">3/1/1/1</div>
                <div class="filter-chip" data-value="2/2/2">2/2/2</div>
                <div class="filter-chip" data-value="2/2/1/1">2/2/1/1</div>
                <div class="filter-chip active" data-value="2/1/1/1/1">2/1/1/1/1</div>
                <div class="filter-chip active" data-value="1/1/1/1/1/1">1/1/1/1/1/1</div>
              </div>
            </div>

            <div class="filter-group" title="Distribuci√≥n de los n√∫meros en las decenas (1-9, 10-19...). '3/2/1' indica 3 n√∫meros en una decena, 2 en otra y 1 en una tercera.">
              <div class="filter-title">üî¢ Agrupaci√≥n por Decenas</div>
              <div class="filter-options" id="agrupDecenasOptions">
                <div class="filter-chip active" data-value="6">6</div>
                <div class="filter-chip active" data-value="5/1">5/1</div>
                <div class="filter-chip active" data-value="4/2">4/2</div>
                <div class="filter-chip active" data-value="4/1/1">4/1/1</div>
                <div class="filter-chip active" data-value="3/3">3/3</div>
                <div class="filter-chip active" data-value="3/2/1">3/2/1</div>
                <div class="filter-chip active" data-value="3/1/1/1">3/1/1/1</div>
                <div class="filter-chip active" data-value="2/2/2">2/2/2</div>
                <div class="filter-chip active" data-value="2/2/1/1">2/2/1/1</div>
                <div class="filter-chip active" data-value="2/1/1/1/1">2/1/1/1/1</div>
              </div>
            </div>
            
            <div class="filter-group" title="La suma de todos los d√≠gitos individuales de los 6 n√∫meros. Es un filtro m√°s sutil para refinar la selecci√≥n.">
              <div class="filter-title">‚àë Suma de D√≠gitos</div>
              <div class="range-control">
                <input type="number" id="sumaDigitosMin" value="28" min="21" max="63">
                <span>a</span>
                <input type="number" id="sumaDigitosMax" value="45" min="21" max="63">
              </div>
              <div class="validation-error" id="sumaDigitosError">El valor m√≠nimo no puede ser mayor que el m√°ximo</div>
            </div>
            
            <!-- GRUPO: Filtros Estad√≠sticos Avanzados -->
             <div class="filter-group" title="Mide la dispersi√≥n de los n√∫meros. Un valor bajo significa que los n√∫meros est√°n muy juntos; un valor alto, que est√°n muy separados. El rango 12-18 es com√∫n.">
              <div class="filter-title">üìà Desviaci√≥n Est√°ndar</div>
              <div class="range-control">
                <input type="number" id="desviacionMin" value="12.0" min="1" max="24" step="0.1">
                <span>a</span>
                <input type="number" id="desviacionMax" value="18.0" min="1" max="24" step="0.1">
              </div>
              <div class="validation-error" id="desviacionError">El valor m√≠nimo no puede ser mayor que el m√°ximo</div>
            </div>

            <div class="filter-group" title="Entrop√≠a de Shannon: Mide la 'aleatoriedad' o dispersi√≥n de los n√∫meros en el tablero. Valores m√°s altos indican mayor dispersi√≥n. Rango t√≠pico: 2.3 - 2.5.">
                <div class="filter-title">üåÄ Entrop√≠a (Shannon)</div>
                <div class="range-control">
                  <input type="number" id="entropyMin" value="2.3" min="1.0" max="2.6" step="0.05">
                  <span>a</span>
                  <input type="number" id="entropyMax" value="2.6" min="1.0" max="2.6" step="0.05">
                </div>
                <div class="validation-error" id="entropyError">El valor m√≠nimo no puede ser mayor que el m√°ximo</div>
            </div>
            
            <!-- GRUPO: Filtros Geom√©tricos -->
            <div class="filter-group" title="Evita o favorece combinaciones que formen visuales en el tablero 7x7.">
              <div class="filter-title">üó∫Ô∏è Patrones Geom√©tricos (Detecci√≥n Real)</div>
              <div class="filter-options" id="geometricOptions">
                <div class="filter-chip" data-value="lineas">üö´ L√≠neas</div>
                <div class="filter-chip" data-value="diagonales">üö´ Diagonales</div>
                <div class="filter-chip" data-value="triangulos">üö´ Tri√°ngulos</div>
                <div class="filter-chip" data-value="circulos">üö´ C√≠rculos</div>
                <div class="filter-chip" data-value="cruces">üö´ Cruces</div>
                <div class="filter-chip" data-value="espaciados">üëç Espaciados</div>
              </div>
            </div>

            <!-- GRUPO: Filtros Predictivos (IA) -->
            <div class="filter-group" title="Utiliza modelos matem√°ticos avanzados basados en datos hist√≥ricos y de comportamiento para optimizar la selecci√≥n.">
              <div class="filter-title">ü§ñ Filtros Predictivos (IA)</div>
              <div class="switch-control">
                <label class="switch">
                  <input type="checkbox" id="useMarkovSwitch">
                  <span class="slider"></span>
                </label>
                <span>Activar Cadenas de Markov</span>
              </div>
               <div class="switch-control" style="margin-top: 10px;">
                <label class="switch">
                  <input type="checkbox" id="useNashSwitch">
                  <span class="slider"></span>
                </label>
                <span>Activar Optimizaci√≥n Nash (Anti-Popular)</span>
              </div>
              <div class="switch-control" style="margin-top: 10px;" title="Favorece combinaciones con n√∫meros que han aparecido con menos frecuencia (fr√≠os), basado en el principio de que los resultados tienden a volver a la media a largo plazo.">
                <label class="switch">
                  <input type="checkbox" id="useRegressionSwitch">
                  <span class="slider"></span>
                </label>
                <span>Activar Regresi√≥n a la Media (Pro-Fr√≠os)</span>
              </div>
              <div class="filter-info-text">
                <b>Markov:</b> Analiza secuencias. <b>Nash:</b> Favorece n√∫meros menos populares. <b>Regresi√≥n:</b> Apuesta por n√∫meros 'atrasados' (fr√≠os).
              </div>
            </div>
            
          </div>
        </div>
      </div>
    </div>

    <div class="saved-tickets-section">
      <h3>üóÇ Boletos Guardados</h3>
      <div class="saved-tickets" id="savedTickets">
        <div style="color:#666; text-align: center; padding: 20px;">No tienes boletos guardados</div>
      </div>
    </div>

    <!-- Modales -->
    <div class="loading" id="loadingModal">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <h3 id="loadingText">Generando combinaci√≥n...</h3>
        <p id="loadingInfo">Iniciando b√∫squeda...</p>
      </div>
    </div>

    <div class="modal" id="validationModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>üîç Validar Boleto</h3>
          <p>Introduce los 6 n√∫meros ganadores separados por espacios, comas o puntos.</p>
        </div>
        <input type="text" class="modal-input" id="winningNumbersInput" placeholder="7, 12. 23 31,42.49" maxlength="23">
        <div id="validationResults"></div>
        <div class="modal-actions">
          <button class="modal-btn cancel" id="cancelValidationBtn">Cerrar</button>
          <button class="modal-btn confirm" id="confirmValidationBtn">Validar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Disclaimer -->
    <div class="modal" id="disclaimerModal">
      <div class="modal-content" style="max-height: 85vh; overflow-y: auto;">
        <div class="modal-header">
          <h3>‚ö†Ô∏è Disclaimer √âtico</h3>
        </div>
        <div style="padding: 15px; color: var(--dark); line-height: 1.6; overflow-y: auto; max-height: 60vh;">
          <p><strong>IMPORTANTE:</strong></p>
          <p>Esta aplicaci√≥n es una herramienta de entretenimiento y an√°lisis estad√≠stico. Los n√∫meros de loter√≠a son completamente aleatorios.</p>
          <p><strong>Recuerda:</strong></p>
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li>No hay forma de predecir n√∫meros ganadores</li>
            <li>Juega solo lo que puedas permitirte perder</li>
            <li>El juego puede crear adicci√≥n</li>
            <li>Esta app no garantiza premios</li>
            <li>Los algoritmos son para an√°lisis, no predicci√≥n</li>
            <li>Los datos hist√≥ricos no predicen futuros resultados</li>
            <li>Los filtros matem√°ticos solo organizan probabilidades</li>
            <li>Las estrategias no aumentan las posibilidades reales de ganar</li>
          </ul>
          <p><strong>Responsabilidad:</strong></p>
          <p>El usuario es completamente responsable de sus decisiones de juego. Esta herramienta no fomenta el juego compulsivo.</p>
          <p><strong>Ayuda:</strong></p>
          <p>Si tienes problemas con el juego, busca ayuda profesional. En Espa√±a: <strong>900 200 225</strong> (L√≠nea de ayuda contra la ludopat√≠a)</p>
          <p style="margin-top: 15px; padding: 10px; background: #fef2f2; border-left: 4px solid var(--danger); border-radius: 4px;">
            <strong>AVISO LEGAL:</strong> Esta aplicaci√≥n es solo para entretenimiento. Los desarrolladores no se responsabilizan por p√©rdidas econ√≥micas derivadas del uso de esta herramienta.
          </p>
        </div>
        <div class="modal-actions">
          <button class="modal-btn confirm" id="disclaimerCloseBtn">Entendido</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" class="hidden-file-input" accept=".csv,.db" multiple>
  </div>

  <script>
// ============================================
// SISTEMA DE ALMACENAMIENTO PERSISTENTE
// ============================================
window.loadDataFromAppInventor = function(fileContent) {
  if (window.app) {
    try {
      const data = window.app.parseCSVData(fileContent);
      window.app.historicalData = data;
      window.app.dataType = 'real';
      window.app.dataLoaded = true;
      window.app.updateDataAnalysis();
      window.app.analyzeNumbers();
      window.app.updateGridWithHotColdNumbers();
      window.app.showToast(`‚úÖ Datos cargados desde App Inventor: ${data.length} sorteos`, 'success');
    } catch (error) {
      window.app.showToast(`Error al procesar datos del archivo: ${error.message}`, 'error');
    }
  }
};

window.receiveAppInventorTickets = function(jsonString) {
  try {
    const data = JSON.parse(jsonString);
    if (data.action === 'TICKETS_LOADED' && window.app) {
      window.app.savedTickets = data.tickets || [];
      window.app.updateSavedTickets();
      console.log(`Cargados ${data.tickets ? data.tickets.length : 0} boletos desde App Inventor`);
    } else if (data.action === 'TICKETS_SAVED' && window.app) {
      window.app.showToast('Boletos guardados en App Inventor', 'success');
    }
  } catch(error) {
    console.error('Error procesando datos de App Inventor:', error);
  }
};

function detectPlatform() {
  if (typeof window.AppInventor !== 'undefined' || 
      window.location.href.includes('appinventor') ||
      navigator.userAgent.includes('AppInventor')) {
    return 'appinventor';
  } else if (window.location.href.includes('appmaker.xyz') ||
             typeof window.appmaker !== 'undefined') {
    return 'appmaker';
  } else {
    return 'web';
  }
}

function requestFileFromAppInventor() {
    if (typeof window.AppInventor !== 'undefined') {
        window.AppInventor.setWebViewString(JSON.stringify({
            action: 'REQUEST_FILE_PICK'
        }));
    } else {
        console.warn("La funci√≥n para solicitar archivos solo est√° disponible en App Inventor.");
        if (window.app) {
            window.app.showToast("Esta funci√≥n solo est√° disponible en la app Android.", "warning");
        }
    }
}


    // Clase principal de la aplicaci√≥n
    class DataLotto49Advanced {
      // Coordenadas pre-calculadas para cada n√∫mero en la cuadr√≠cula 7x7
      static NUMBER_COORDS = (() => {
          const coords = {};
          for (let i = 1; i <= 49; i++) {
              coords[i] = { row: Math.floor((i - 1) / 7), col: (i - 1) % 7 };
          }
          return coords;
      })();

      constructor() {
        // Estado del sistema
        this.selectedNumbers = new Set();
        this.excludedNumbers = new Set();
        this.hotNumbers = new Set();
        this.coldNumbers = new Set();
        this.currentSelectionMode = null; // null | 'excluded' | 'hot' | 'cold'
        this.isGenerating = false;
        this.savedTickets = [];
        this.currentTicket = null;
        this.currentValidatingTicket = null;
        this.historicalData = [];
        this.numberStats = {};
        this.analysisPeriod = 100;
        this.dataLoaded = false;
        this.dataType = 'none';
        this.platform = detectPlatform();

        // Filtros (activados todos los niveles)
        this.filters = {
          terminaciones: [],
          sum: { min: 121, max: 190 },
          parImpar: [],
          bajosAltos: [],
          primos: { min: 1, max: 3 },
          consecutivos: [],
          agrupDecenas: [],
          sumaDigitos: { min: 28, max: 45 },
          desviacion: { min: 12.0, max: 18.0 },
          entropy: { min: 2.3, max: 2.6 },
          geometric: { exclude: [], favor: [] },
          useMarkov: false,
          useNash: false,
          useRegression: false,
        };
        
        // Constantes y pre-c√°lculos
        this.primes = new Set([2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47]);
        this.TOLERANCE_LEVELS = { // Niveles de tolerancia para la estrategia M√∫ltiple
            7: 0.70,
            8: 0.50,
            9: 0.35,
            10: 0.25,
            11: 0.20
        };

        this.init();
      }

      init() {
        this.initializeHistoricalData();
        this.analyzeNumbers();
        this.createNumbersGrid();
        this.bindEvents();
        this.loadTickets();
        this.updateFilterStateFromUI();
        if (this.platform === 'appinventor') {
            this.requestInitialDataFromAppInventor();
        }
      }
      
      requestInitialDataFromAppInventor() {
        if (typeof window.AppInventor !== 'undefined') {
            window.AppInventor.setWebViewString(JSON.stringify({ action: 'REQUEST_TICKETS' }));
        }
      }

      // ===== DATOS HIST√ìRICOS (Sin cambios) =====
      initializeHistoricalData() {
        if (!this.dataLoaded) {
          this.simulateHistoricalData(500);
        }
      }
      simulateHistoricalData(numDraws = 500) {
        this.historicalData = [];
        const baseDate = new Date();
        baseDate.setDate(baseDate.getDate() - numDraws * 3.5);

        for(let i = 0; i < numDraws; i++) {
          const drawDate = new Date(baseDate);
          drawDate.setDate(drawDate.getDate() + (i * 3.5));
          const numbers = this.generateRealisticDraw();
          this.historicalData.push({
            id: i + 1,
            date: drawDate,
            numbers: numbers.sort((a, b) => a - b),
            sum: numbers.reduce((a, b) => a + b, 0)
          });
        }
        
        this.dataType = 'simulated';
        this.dataLoaded = true;
        this.updateDataAnalysis();
        this.analyzeNumbers();
        this.updateGridWithHotColdNumbers();
        this.showToast('‚úÖ Datos simulados generados correctamente', 'success');
      }
      generateRealisticDraw() {
        const numbers = new Set();
        while(numbers.size < 6) {
            const num = Math.floor(Math.random() * 49) + 1;
            if(!numbers.has(num)) {
                numbers.add(num);
            }
        }
        return Array.from(numbers);
      }
      async loadRealData(files) {
        try {
          this.historicalData = [];
          let totalDraws = 0;
          
          for (const file of files) {
            const data = await this.loadDataFile(file);
            this.historicalData.push(...data);
            totalDraws += data.length;
          }
          
          this.historicalData.sort((a, b) => new Date(a.date) - new Date(b.date));
          this.historicalData.forEach((draw, index) => {
            draw.id = index + 1;
          });
          
          this.dataType = 'real';
          this.dataLoaded = true;
          this.updateDataAnalysis();
          this.analyzeNumbers();
          this.updateGridWithHotColdNumbers(); // CORREGIDO
          
          this.showToast(`‚úÖ Datos reales cargados: ${totalDraws} sorteos`, 'success');
          
        } catch (error) {
          this.showToast(`Error cargando datos: ${error.message}`, 'error');
        }
      }
      async loadDataFromUrl() {
        const url = prompt("Introduce la URL del archivo de datos (CSV):");
        if (!url) return;
        try {
          this.showLoading('Cargando datos desde URL...');
          const response = await fetch(url);
          if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
          const content = await response.text();
          const data = this.parseCSVData(content);
          
          this.historicalData = data;
          this.dataType = 'url';
          this.dataLoaded = true;
          this.updateDataAnalysis();
          this.analyzeNumbers();
          this.updateGridWithHotColdNumbers(); // CORREGIDO
          this.hideLoading();
          this.showToast(`‚úÖ Datos cargados desde URL: ${data.length} sorteos`, 'success');
        } catch (error) {
          this.hideLoading();
          this.showToast(`Error al cargar desde URL: ${error.message}`, 'error');
        }
      }
      async loadDataFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const content = e.target.result;
              resolve(this.parseCSVData(content));
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = () => reject(new Error('Error leyendo archivo'));
          reader.readAsText(file);
        });
      }
      parseCSVData(content) {
        const lines = content.trim().split('\n');
        return lines.map((line, i) => {
          if (!line.trim()) return null;
          const numbers = line.split(/[,;\t\s]+/).map(n => parseInt(n.trim())).filter(n => !isNaN(n));
          if (numbers.length !== 6) throw new Error(`L√≠nea ${i + 1}: Se esperan 6 n√∫meros`);
          if (numbers.some(n => n < 1 || n > 49)) throw new Error(`L√≠nea ${i + 1}: N√∫meros fuera de rango`);
          return {
            id: i + 1,
            date: new Date(Date.now() - (lines.length - i) * 3.5 * 24 * 60 * 60 * 1000),
            numbers: numbers.sort((a, b) => a - b),
            sum: numbers.reduce((a, b) => a + b, 0)
          };
        }).filter(Boolean);
      }
      updateDataAnalysis() {
        const dataInfo = document.getElementById('dataInfo');
        const dataStatsGrid = document.getElementById('dataStatsGrid');
        if (!dataInfo || !dataStatsGrid) return;
        
        if (!this.dataLoaded || this.historicalData.length === 0) {
          dataInfo.textContent = 'No hay datos cargados. Carga una base de datos CSV/DB o simula datos hist√≥ricos.';
          dataInfo.className = 'data-info';
          dataStatsGrid.style.display = 'none';
          return;
        }
        const frequencies = {};
        for (let i = 1; i <= 49; i++) frequencies[i] = 0;
        this.historicalData.forEach(draw => draw.numbers.forEach(num => frequencies[num]++));
        const sortedFreq = Object.entries(frequencies).sort((a, b) => b[1] - a[1]);
        dataInfo.innerHTML = `üìä ${this.historicalData.length} sorteos cargados (${this.dataType === 'real' ? 'DATOS REALES' : 'DATOS SIMULADOS'})`;
        dataInfo.className = 'data-info has-data';
        
        const safeSetText = (id, text) => {
          const el = document.getElementById(id);
          if (el) el.textContent = text;
        };
        
        safeSetText('totalDraws', this.historicalData.length);
        safeSetText('dataType', this.dataType.toUpperCase());
        safeSetText('mostFrequent', sortedFreq.slice(0, 3).map(([num]) => num).join(', '));
        safeSetText('leastFrequent', sortedFreq.slice(-3).map(([num]) => num).join(', '));
        
        const chiSquareEl = document.getElementById('chiSquare');
        const biasEl = document.getElementById('biasDetected');

        if (this.historicalData.length >= 50 && chiSquareEl && biasEl) {
            const expectedFrequency = (this.historicalData.length * 6) / 49;
            let chiSquareStat = 0;
            for (let i = 1; i <= 49; i++) {
                chiSquareStat += Math.pow(frequencies[i] - expectedFrequency, 2) / expectedFrequency;
            }
            const criticalValue = 65.17; // df=48, p=0.05
            const biasDetected = chiSquareStat > criticalValue;
            
            chiSquareEl.textContent = chiSquareStat.toFixed(2);
            biasEl.textContent = biasDetected ? 'S√≠ (Significativo al 95%)' : 'No (Distribuci√≥n Normal)';
            biasEl.classList.toggle('invalid', biasDetected);
            biasEl.classList.toggle('valid', !biasDetected);
        } else if(chiSquareEl && biasEl) {
            chiSquareEl.textContent = 'N/A';
            biasEl.textContent = 'Datos insuficientes';
            biasEl.classList.remove('valid', 'invalid');
        }
        
        dataStatsGrid.style.display = 'grid';
      }

      // ===== AN√ÅLISIS DE N√öMEROS (Sin cambios) =====
      analyzeNumbers() {
        for(let i = 1; i <= 49; i++) this.numberStats[i] = { frequency: 0, score: 0 };
        const analysisData = this.historicalData.slice(-this.analysisPeriod);
        if (analysisData.length === 0) return;
        analysisData.forEach(draw => draw.numbers.forEach(num => this.numberStats[num].frequency++));
        this.classifyNumbers();
      }
      classifyNumbers() {
        const freqs = Object.values(this.numberStats).map(s => s.frequency);
        const sortedFreqs = [...freqs].sort((a, b) => a - b);
        const hotThreshold = sortedFreqs[Math.floor(sortedFreqs.length * 0.7)];
        const coldThreshold = sortedFreqs[Math.floor(sortedFreqs.length * 0.3)];
        this.hotNumbers.clear();
        this.coldNumbers.clear();
        for (let num = 1; num <= 49; num++) {
          const freq = this.numberStats[num].frequency;
          if (freq >= hotThreshold) this.hotNumbers.add(num);
          if (freq <= coldThreshold) this.coldNumbers.add(num);
        }
      }
      updateGridWithHotColdNumbers() {
        for (let i = 1; i <= 49; i++) {
          const ball = document.querySelector(`.number-ball[data-number="${i}"]`);
          if (ball) {
            ball.classList.remove('hot', 'cold');
            const icon = ball.querySelector('.number-icon');
            if (!icon) continue;

            let newIcon = '';
            
            if (this.hotNumbers.has(i)) {
                ball.classList.add('hot');
                newIcon = 'üî•';
            }
            if (this.coldNumbers.has(i)) {
                ball.classList.add('cold');
                newIcon = '‚ùÑÔ∏è';
            }
            
            const currentIcon = icon.textContent;
            if (['üî•', '‚ùÑÔ∏è', ''].includes(currentIcon) && !this.excludedNumbers.has(i)) {
                icon.textContent = newIcon;
            }
          }
        }
      }

      // ===== UI SETUP Y EVENTOS (Sin cambios en su mayor√≠a) =====
      createNumbersGrid() {
        const grid = document.getElementById('numbersGrid');
        if (!grid) return;
        grid.innerHTML = '';
        for (let i = 1; i <= 49; i++) {
          const ball = document.createElement('div');
          ball.classList.add('number-ball');
          ball.dataset.number = i;
          ball.innerHTML = `${i}<span class="number-icon"></span>`;
          if (this.hotNumbers.has(i)) ball.classList.add('hot');
          if (this.coldNumbers.has(i)) ball.classList.add('cold');
          grid.appendChild(ball);
        }
      }
      bindEvents() {
        document.getElementById('numbersGrid')?.addEventListener('click', e => {
          if (e.target.classList.contains('number-ball')) this.handleNumberClick(e.target);
        });
        document.querySelector('.selection-mode-controls')?.addEventListener('click', e => {
            const btn = e.target.closest('.selection-mode-btn');
            if (!btn) return;
            const mode = btn.dataset.mode;
            
            if (['cold', 'hot', 'excluded'].includes(mode)) {
                this.updateSelectionMode(mode);
            } else if (btn.id === 'randomBtn') {
                this.randomSelect();
            } else if (btn.id === 'clearBtn') {
                this.clearSelections(true);
                const clearBtn = document.getElementById('clearBtn');
                if (clearBtn) {
                  clearBtn.classList.add('shake');
                  setTimeout(() => clearBtn.classList.remove('shake'), 500);
                }
            } else if (btn.id === 'dataBtn') {
                document.getElementById('fileInput')?.click();
            } else if (btn.id === 'simulateBtn') {
                this.simulateHistoricalData(500);
            } else if (btn.id === 'urlBtn') {
                this.loadDataFromUrl();
            }
        });
        document.querySelectorAll('.collapsible-header').forEach(h => h.addEventListener('click', () => this.toggleCollapse(h.dataset.target)));
        document.querySelectorAll('.strategy-btn').forEach(btn => btn.addEventListener('click', () => this.updateStrategyUI(btn.dataset.strategy)));
        document.querySelectorAll('.number-option').forEach(opt => opt.addEventListener('click', () => {
          document.querySelectorAll('.number-option').forEach(o => o.classList.remove('active'));
          opt.classList.add('active');
        }));
        document.getElementById('generateBtn')?.addEventListener('click', () => this.generateCombinations());
        document.getElementById('saveBtn')?.addEventListener('click', () => this.saveTicket());
        document.getElementById('shareBtn')?.addEventListener('click', () => this.shareTicket());
        document.querySelector('.filters-panel')?.addEventListener('input', () => this.updateFilterStateFromUI());
        document.querySelector('.filters-panel')?.addEventListener('click', e => {
           if(e.target.classList.contains('filter-chip')) {
               e.target.classList.toggle('active');
               this.updateFilterStateFromUI();
           }
        });
        document.getElementById('disclaimerBtn')?.addEventListener('click', () => this.toggleModal('disclaimerModal', true));
        document.getElementById('disclaimerCloseBtn')?.addEventListener('click', () => this.toggleModal('disclaimerModal', false));
        document.getElementById('cancelValidationBtn')?.addEventListener('click', () => this.toggleModal('validationModal', false));
        document.getElementById('confirmValidationBtn')?.addEventListener('click', () => this.confirmValidation());
        document.getElementById('fileInput')?.addEventListener('change', e => e.target.files.length > 0 && this.loadRealData(e.target.files));
      }

      // ===== FILTROS (Reactivados y completos) =====
      updateFilterStateFromUI() {
          const getVal = (id, isFloat = false) => {
              const el = document.getElementById(id);
              if (!el) return isFloat ? 0.0 : 0;
              return isFloat ? parseFloat(el.value) : parseInt(el.value);
          };
          const getChecked = (id) => document.getElementById(id)?.checked || false;
          const getActiveChips = (selector) => Array.from(document.querySelectorAll(selector)).map(el => el.dataset.value);

          this.filters.terminaciones = getActiveChips('#terminacionesOptions .filter-chip.active').map(Number);
          this.filters.sum = { min: getVal('sumMin'), max: getVal('sumMax') };
          this.filters.parImpar = getActiveChips('#parImparOptions .filter-chip.active');
          this.filters.bajosAltos = getActiveChips('#bajosAltosOptions .filter-chip.active');
          this.filters.primos = { min: getVal('primosMin'), max: getVal('primosMax') };
          this.filters.consecutivos = getActiveChips('#consecutivosOptions .filter-chip.active');
          this.filters.agrupDecenas = getActiveChips('#agrupDecenasOptions .filter-chip.active');
          this.filters.sumaDigitos = { min: getVal('sumaDigitosMin'), max: getVal('sumaDigitosMax') };
          this.filters.desviacion = { min: getVal('desviacionMin', true), max: getVal('desviacionMax', true) };
          this.filters.entropy = { min: getVal('entropyMin', true), max: getVal('entropyMax', true) };
          
          const geometricChips = Array.from(document.querySelectorAll('#geometricOptions .filter-chip.active'));
          this.filters.geometric = {
              exclude: geometricChips.filter(el => el.textContent.startsWith('üö´')).map(el => el.dataset.value),
              favor: geometricChips.filter(el => el.textContent.startsWith('üëç')).map(el => el.dataset.value),
          };
          
          this.filters.useMarkov = getChecked('useMarkovSwitch');
          this.filters.useNash = getChecked('useNashSwitch');
          this.filters.useRegression = getChecked('useRegressionSwitch');
      }

      // ===== SELECCI√ìN DE N√öMEROS (CORREGIDO) =====
      handleNumberClick(ball) {
        const number = parseInt(ball.dataset.number);
        const icon = ball.querySelector('.number-icon');
        if (!icon) return;
        
        if (this.excludedNumbers.has(number) && this.currentSelectionMode !== 'excluded') {
            this.showToast('Este n√∫mero est√° excluido.', 'warning');
            return;
        }

        switch (this.currentSelectionMode) {
            case 'excluded':
                if (this.selectedNumbers.has(number)) {
                    this.showToast('No puedes excluir un n√∫mero ya seleccionado.', 'warning');
                    return;
                }
                this.excludedNumbers.has(number) ? this.excludedNumbers.delete(number) : this.excludedNumbers.add(number);
                ball.classList.toggle('excluded');
                if (this.excludedNumbers.has(number)) {
                    icon.textContent = 'üö´';
                } else {
                    if (this.hotNumbers.has(number)) icon.textContent = 'üî•';
                    else if (this.coldNumbers.has(number)) icon.textContent = '‚ùÑÔ∏è';
                    else icon.textContent = '';
                }
                break;

            case 'hot':
                if (this.coldNumbers.has(number)) {
                    this.coldNumbers.delete(number);
                    document.querySelector(`.number-ball[data-number="${number}"]`)?.classList.remove('cold');
                }
                this.hotNumbers.has(number) ? this.hotNumbers.delete(number) : this.hotNumbers.add(number);
                ball.classList.toggle('hot');
                icon.textContent = this.hotNumbers.has(number) ? 'üî•' : '';
                break;

            case 'cold':
                if (this.hotNumbers.has(number)) {
                    this.hotNumbers.delete(number);
                    document.querySelector(`.number-ball[data-number="${number}"]`)?.classList.remove('hot');
                }
                this.coldNumbers.has(number) ? this.coldNumbers.delete(number) : this.coldNumbers.add(number);
                ball.classList.toggle('cold');
                icon.textContent = this.coldNumbers.has(number) ? '‚ùÑÔ∏è' : '';
                break;

            default: // Normal selection mode
                if (this.excludedNumbers.has(number)) return;
                if (document.querySelector('.random-pick, .generated-pick')) {
                    this.clearGridHighlights();
                    this.selectedNumbers.clear();
                }
                this.selectedNumbers.has(number) ? this.removeNumber(number) : this.addNumber(number);
                break;
        }
      }
      addNumber(number) {
        if (this.selectedNumbers.size < 6) {
          this.selectedNumbers.add(number);
          document.querySelector(`.number-ball[data-number="${number}"]`)?.classList.add('selected');
          this.updateSelectedDisplay();
          this.updateStats();
        }
      }
      removeNumber(number) {
        this.selectedNumbers.delete(number);
        document.querySelector(`.number-ball[data-number="${number}"]`)?.classList.remove('selected');
        this.updateSelectedDisplay();
        this.updateStats();
      }
      clearSelections(fullClear) {
        this.selectedNumbers.clear();
        if (fullClear) {
          this.excludedNumbers.clear();
          this.hotNumbers.clear();
          this.coldNumbers.clear();
          document.querySelectorAll('.number-ball').forEach(b => {
              b.classList.remove('excluded', 'hot', 'cold');
              const icon = b.querySelector('.number-icon');
              if (icon) icon.textContent = '';
          });
          this.analyzeNumbers();
          this.updateGridWithHotColdNumbers();
        }
        document.querySelectorAll('.number-ball.selected').forEach(b => b.classList.remove('selected'));
        this.clearGridHighlights();
        this.updateSelectedDisplay();
        this.updateStats();
      }
      randomSelect() {
        this.clearSelections(false);
        const available = this.getAvailableUniverse();
        if (available.length < 6) {
          this.showToast('No hay suficientes n√∫meros para seleccionar 6 al azar.', 'warning');
          return;
        }
        
        const randomNumbers = [];
        while (randomNumbers.length < 6) {
          const randomIndex = Math.floor(Math.random() * available.length);
          const number = available.splice(randomIndex, 1)[0];
          randomNumbers.push(number);
          const ball = document.querySelector(`.number-ball[data-number="${number}"]`);
          if (ball) {
            ball.classList.add('random-pick');
            const icon = ball.querySelector('.number-icon');
            if (icon) icon.textContent = 'üé≤';
          }
        }
        
        this.selectedNumbers = new Set(randomNumbers);
        this.updateTopDisplayWithCombination(randomNumbers, 'random');
        this.updateStats();
      }
      updateSelectionMode(mode) {
        const isTogglingOff = this.currentSelectionMode === mode;
        this.currentSelectionMode = null;
        document.querySelectorAll('.selection-mode-btn[data-mode]').forEach(b => {
            if (['cold', 'hot', 'excluded'].includes(b.dataset.mode)) {
                b.classList.remove('active');
            }
        });

        if (isTogglingOff) {
            this.showToast('Modo de selecci√≥n normal activado', 'info');
        } else {
            this.currentSelectionMode = mode;
            document.querySelector(`.selection-mode-btn[data-mode="${mode}"]`)?.classList.add('active');
            const modeText = {
                excluded: 'marcar n√∫meros excluidos',
                hot: 'marcar n√∫meros Calientes',
                cold: 'marcar n√∫meros Fr√≠os'
            };
            this.showToast(`Modo para ${modeText[mode]} activado`, 'info');
        }
      }
      updateSelectedDisplay() {
        const display = document.getElementById('selectedDisplay');
        if (!display) return;
        display.innerHTML = '';
        if (this.selectedNumbers.size === 0) {
          display.innerHTML = `<div style="color:#666; font-style: italic;">Selecciona hasta 6 n√∫meros</div>`;
        } else {
          Array.from(this.selectedNumbers).sort((a,b)=>a-b).forEach(num => {
            const ball = document.createElement('div');
            ball.classList.add('number-ball', 'selected');
            ball.style.cssText = 'width: 35px; height: 35px; cursor: default;';
            ball.textContent = num;
            display.appendChild(ball);
          });
        }
      }

      updateTopDisplayWithCombination(combination, type = 'generated') {
        const display = document.getElementById('selectedDisplay');
        if (!display) return;
        display.innerHTML = '';
        if (!combination || combination.length === 0) {
            display.innerHTML = `<div style="color:#666; font-style: italic;">No se gener√≥ ninguna combinaci√≥n.</div>`;
            return;
        }

        const className = type === 'random' ? 'random-pick' : 'generated-pick';

        combination.sort((a, b) => a - b).forEach(num => {
            const ball = document.createElement('div');
            ball.classList.add('number-ball', className);
            ball.style.cssText = 'width: 35px; height: 35px; cursor: default;';
            ball.textContent = num;
            display.appendChild(ball);
        });
      }

      // ===== UI STRATEGY (Sin cambios) =====
      updateStrategyUI(strategy) {
        document.querySelectorAll('.strategy-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.strategy-btn[data-strategy="${strategy}"]`)?.classList.add('active');
        const winningOptions = document.getElementById('winningOptions');
        const multipleOptions = document.getElementById('multipleNumbersOptions');
        if(winningOptions) winningOptions.style.display = strategy === 'winning' ? 'block' : 'none';
        if(multipleOptions) multipleOptions.style.display = strategy === 'multiple' ? 'block' : 'none';
      }
      
      // ===========================================
      // ===== MOTOR DE GENERACI√ìN (CORREGIDO) =====
      // ===========================================
      async generateCombinations() {
        if (this.isGenerating) return;

        this.clearSelections(false);

        this.isGenerating = true;
        this.showLoading('Iniciando...');
        
        this.updateFilterStateFromUI();
        const availableUniverse = this.getAvailableUniverse();

        if (availableUniverse.length < 6) {
          this.showToast('Imposible generar. Menos de 6 n√∫meros disponibles con los filtros de exclusi√≥n actuales.', 'error');
          this.hideLoading();
          this.isGenerating = false;
          return;
        }

        const strategy = document.querySelector('.strategy-btn.active')?.dataset.strategy;
        let combinations = [];

        await new Promise(resolve => setTimeout(resolve, 50));

        try {
          if (strategy === 'simple') {
              this.showLoading('Buscando combinaci√≥n...');
              const result = this.findValidCombinations(availableUniverse, 1, 500000);
              if (result.length > 0) combinations = result;
          } else if (strategy === 'winning') {
              const generateCount = parseInt(document.getElementById('generateCount')?.value || 100);
              const playCount = parseInt(document.getElementById('playCount')?.value || 10);
              combinations = await this.findAndRankWinningCombinations(availableUniverse, generateCount, playCount);
          } else if (strategy === 'multiple') {
            const numCount = parseInt(document.querySelector('.number-option.active')?.dataset.numbers || 7);
            if (availableUniverse.length < numCount) {
              throw new Error(`No hay suficientes n√∫meros (${availableUniverse.length}) para una m√∫ltiple de ${numCount}.`);
            }
            const foundSuperset = await this.findValidSuperset(availableUniverse, numCount);
            if (foundSuperset) {
                combinations = [foundSuperset];
            }
          }

          if (combinations.length > 0) {
            this.displayTicket(combinations, strategy);
          } else {
             this.showToast('No se encontr√≥ ninguna combinaci√≥n que cumpla todos los filtros. Prueba a flexibilizarlos.', 'warning');
          }

        } catch (error) {
            this.showToast(`Error: ${error.message}`, 'error');
        } finally {
            this.hideLoading();
            this.isGenerating = false;
        }
      }

      getAvailableUniverse() {
        let universe = [];
        for (let i = 1; i <= 49; i++) {
          if (this.excludedNumbers.has(i)) continue;
          if (this.filters.terminaciones.includes(i % 10)) continue;
          universe.push(i);
        }
        return universe;
      }

      async findAndRankWinningCombinations(universe, generateCount, playCount) {
        this.showLoading(`Buscando ${generateCount} v√°lidas...`);
        const loadingInfo = document.getElementById('loadingInfo');

        const validCombos = [];
        const maxAttempts = Math.max(500000, generateCount * 100);
        
        for(let i=0; i < maxAttempts && validCombos.length < generateCount; i++) {
            if (i % 500 === 0) {
                if (loadingInfo) loadingInfo.textContent = `${validCombos.length} / ${generateCount} encontradas... (Intento ${i})`;
                await new Promise(resolve => setTimeout(resolve, 0));
            }
            const combo = this.generateRandomCombination(universe, 6);
            if (this.isValidCombination(combo)) {
                validCombos.push(combo);
            }
        }

        if (validCombos.length === 0) {
            throw new Error('No se encontraron combinaciones v√°lidas. Intenta flexibilizar los filtros.');
        }

        this.showLoading('Puntuando y ordenando...');
        if (loadingInfo) loadingInfo.textContent = `Puntuando ${validCombos.length} combinaciones...`;
        await new Promise(resolve => setTimeout(resolve, 0));

        const scoredCombos = validCombos.map(combo => ({
            combo,
            score: this.calculateCombinationScore(combo)
        }));

        scoredCombos.sort((a, b) => b.score - a.score);
        return scoredCombos.slice(0, playCount).map(item => item.combo);
      }

      async findValidSuperset(universe, numCount) {
        this.showLoading(`Buscando M√∫ltiple de ${numCount}...`);
        const loadingInfo = document.getElementById('loadingInfo');
        
        const tolerance = this.TOLERANCE_LEVELS[numCount];
        const maxAttempts = 50000;
        
        for (let attempt = 1; attempt <= maxAttempts; attempt++) {
            if (attempt % 100 === 0) {
                if(loadingInfo) loadingInfo.textContent = `Intento ${attempt} de ${maxAttempts}...`;
                await new Promise(resolve => setTimeout(resolve, 0));
            }

            const candidateSuperset = this.generateRandomCombination(universe, numCount);
            const subCombinations = this.getCombinations(candidateSuperset, 6);
            const totalSubCombos = subCombinations.length;
            const requiredValidCount = Math.ceil(totalSubCombos * tolerance);
            
            let validCount = 0;
            for (const subCombo of subCombinations) {
                if (this.isValidCombination(subCombo)) {
                    validCount++;
                }
            }

            if (validCount >= requiredValidCount) {
                if(loadingInfo) loadingInfo.textContent = `¬°Superconjunto v√°lido encontrado!`;
                return candidateSuperset.sort((a, b) => a - b);
            }
        }
        if(loadingInfo) loadingInfo.textContent = `B√∫squeda finalizada sin √©xito.`;
        return null;
      }

      findValidCombinations(universe, count, maxAttempts) {
          const validCombinations = [];
          for (let i = 0; i < maxAttempts && validCombinations.length < count; i++) {
              const combo = this.generateRandomCombination(universe, 6);
              if (this.isValidCombination(combo)) {
                  validCombinations.push(combo);
              }
          }
          return validCombinations;
      }
      
      isValidCombination(combination) {
          const stats = this.getCombinationStats(combination);
          if (Object.keys(stats).length === 0) return false;

          // Nivel 2
          if (stats.sum < this.filters.sum.min || stats.sum > this.filters.sum.max) return false;
          if (this.filters.parImpar.length > 0 && !this.filters.parImpar.includes(stats.parImpar)) return false;
          if (this.filters.bajosAltos.length > 0 && !this.filters.bajosAltos.includes(stats.bajosAltos)) return false;
          if (stats.primos < this.filters.primos.min || stats.primos > this.filters.primos.max) return false;
          if (this.filters.consecutivos.length > 0 && !this.filters.consecutivos.includes(stats.consecutivos)) return false;
          if (this.filters.agrupDecenas.length > 0 && !this.filters.agrupDecenas.includes(stats.agrupDecenas)) return false;
          if (stats.sumaDigitos < this.filters.sumaDigitos.min || stats.sumaDigitos > this.filters.sumaDigitos.max) return false;
          
          // Nivel 3 Exclusions
          if (stats._desviacion < this.filters.desviacion.min || stats._desviacion > this.filters.desviacion.max) return false;
          if (stats._entropia < this.filters.entropy.min || stats._entropia > this.filters.entropy.max) return false;
          if (this.filters.geometric.exclude.length > 0 && this.hasGeometricPattern(combination, this.filters.geometric.exclude)) return false;

          return true;
      }

      generateRandomCombination(universe, count) {
        let tempUniverse = [...universe];
        let combination = [];
        while (combination.length < count && tempUniverse.length > 0) {
          const randomIndex = Math.floor(Math.random() * tempUniverse.length);
          combination.push(tempUniverse.splice(randomIndex, 1)[0]);
        }
        return combination.sort((a, b) => a - b);
      }
      
      getCombinations(source, k) {
        if (k > source.length || k <= 0) return [];
        if (k === source.length) return [source];
        if (k === 1) return source.map(item => [item]);

        const result = [];
        const stack = [[0, []]];
        while (stack.length > 0) {
            const [index, currentCombo] = stack.pop();

            if (currentCombo.length === k) {
                result.push(currentCombo);
                continue;
            }
            if (index >= source.length) continue;

            stack.push([index + 1, currentCombo]);
            stack.push([index + 1, [...currentCombo, source[index]]]);
        }
        return result;
      }
      
      // ===== ESTAD√çSTICAS Y VALIDACI√ìN (CORREGIDO) =====
      updateStats() {
        this.displayCombinationStats(Array.from(this.selectedNumbers));
      }

      displayCombinationStats(combination) {
        const statsContent = document.getElementById('statsContent');
        if (!statsContent) return;
        
        const safeSetText = (id, text) => {
          const el = document.getElementById(id);
          if (el) el.textContent = text;
        };
        
        if (!combination || combination.length !== 6) {
            statsContent.querySelectorAll('.stat-value').forEach(el => el.textContent = '-');
            return;
        }
        const stats = this.getCombinationStats(combination);
        for (const key in stats) {
            if (key.startsWith('_')) continue; // No mostrar valores raw
            const elId = `stat${key.charAt(0).toUpperCase() + key.slice(1)}`;
            safeSetText(elId, stats[key]);
        }
      }

      getCombinationStats(combination) {
        if (combination.length !== 6) return {};
        const sum = combination.reduce((a, b) => a + b, 0);
        const evens = combination.filter(n => n % 2 === 0).length;
        const lows = combination.filter(n => n <= 25).length;
        const primesCount = combination.filter(n => this.primes.has(n)).length;
        
        const sorted = [...combination].sort((a,b)=>a-b);
        let consecutivePattern = '';
        let count = 1;
        for (let i = 1; i < sorted.length; i++) {
            if (sorted[i] === sorted[i-1] + 1) {
                count++;
            } else {
                consecutivePattern += count;
                count = 1;
            }
        }
        consecutivePattern += count;
        const consecPatternSorted = consecutivePattern.split('').sort((a,b)=>b-a).join('/');
        
        const tens = {};
        combination.forEach(n => {
            const ten = Math.floor((n-1)/10);
            tens[ten] = (tens[ten] || 0) + 1;
        });
        const tensGroups = Object.values(tens).sort((a,b)=>b-a).join('/');

        const digitSum = combination.reduce((sum, num) => sum + (num < 10 ? num : (num % 10 + Math.floor(num/10))), 0);
        
        const mean = sum / 6;
        const stdDev = Math.sqrt(combination.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / 6);

        const counts = {};
        combination.forEach(n => { counts[n] = (counts[n] || 0) + 1; });
        const entropy = -Object.values(counts).reduce((sum, count) => {
            const p = count / 6;
            return sum + p * Math.log2(p);
        }, 0);

        return {
          suma: sum,
          parImpar: `${evens}/${6-evens}`,
          bajosAltos: `${lows}/${6-lows}`,
          primos: primesCount,
          consecutivos: consecPatternSorted,
          agrupDecenas: tensGroups,
          sumaDigitos: digitSum,
          desviacion: stdDev.toFixed(2),
          entropia: entropy.toFixed(3),
          _desviacion: stdDev,
          _entropia: entropy,
        };
      }
      
      clearGridHighlights() {
        document.querySelectorAll('.number-ball.generated-pick, .number-ball.random-pick').forEach(ball => {
            ball.classList.remove('generated-pick', 'random-pick');
            const icon = ball.querySelector('.number-icon');
            if (!icon) return;

            const num = parseInt(ball.dataset.number);
            
            if(this.excludedNumbers.has(num)) {
                icon.textContent = 'üö´';
            } else if(this.hotNumbers.has(num)) {
                icon.textContent = 'üî•';
            } else if(this.coldNumbers.has(num)) {
                icon.textContent = '‚ùÑÔ∏è';
            } else {
                icon.textContent = '';
            }
        });
      }
      
      // ===== TICKET & STORAGE (CORREGIDO) =====
      displayTicket(combinations, strategy) {
        this.currentTicket = { date: new Date().toISOString(), combinations, strategy };
        const ticketDiv = document.getElementById('ticket');
        const combinationsDiv = document.getElementById('ticketCombinations');
        const ticketDateEl = document.getElementById('ticketDate');
        if (ticketDateEl) ticketDateEl.textContent = new Date().toLocaleString();
        
        if (!combinationsDiv || !ticketDiv) return;
        combinationsDiv.innerHTML = '';
        
        combinations.forEach(combo => {
            const comboDiv = document.createElement('div');
            comboDiv.className = 'ticket-combination';
            combo.sort((a,b)=>a-b).forEach(num => {
                const numDiv = document.createElement('div');
                numDiv.className = 'ticket-number';
                numDiv.textContent = num;
                comboDiv.appendChild(numDiv);
            });
            combinationsDiv.appendChild(comboDiv);
        });
        
        this.clearGridHighlights();

        if (strategy !== 'multiple' && combinations.length > 0) {
            this.updateTopDisplayWithCombination(combinations[0], 'generated');
        } else {
            const display = document.getElementById('selectedDisplay');
            const message = strategy === 'multiple' ? 'M√∫ltiple generada. Ver boleto.' : 'Selecciona hasta 6 n√∫meros';
            if(display) display.innerHTML = `<div style="color:#666; font-style: italic;">${message}</div>`;
        }

        const firstResult = combinations[0];
        if (firstResult) {
            firstResult.forEach(num => {
                const ball = document.querySelector(`.number-ball[data-number="${num}"]`);
                if (ball) {
                    ball.classList.add('generated-pick');
                    const icon = ball.querySelector('.number-icon');
                    if(icon) icon.textContent = 'ü§ñ';
                }
            });
            
            if (strategy === 'multiple') {
                this.displayCombinationStats([]);
            } else {
                this.displayCombinationStats(firstResult);
            }
        }
        
        ticketDiv.classList.add('show');
      }
      saveTicket() {
        if (!this.currentTicket) return;
        this.savedTickets.unshift(this.currentTicket);
        if (this.platform === 'appinventor') {
            if (typeof window.AppInventor !== 'undefined') {
                window.AppInventor.setWebViewString(JSON.stringify({ action: 'SAVE_TICKETS', tickets: this.savedTickets }));
            }
        } else {
            localStorage.setItem('lotto49_tickets', JSON.stringify(this.savedTickets));
            this.showToast('‚úÖ Boleto guardado localmente', 'success');
        }
        this.updateSavedTickets();
        this.currentTicket = null;
        const ticketDiv = document.getElementById('ticket');
        if(ticketDiv) ticketDiv.classList.remove('show');
      }
      loadTickets() {
        if (this.platform === 'web') {
            const tickets = localStorage.getItem('lotto49_tickets');
            this.savedTickets = tickets ? JSON.parse(tickets) : [];
            this.updateSavedTickets();
        }
      }
      deleteTicket(date) {
        this.savedTickets = this.savedTickets.filter(t => t.date !== date);
         if (this.platform === 'appinventor') {
            if (typeof window.AppInventor !== 'undefined') {
                window.AppInventor.setWebViewString(JSON.stringify({ action: 'SAVE_TICKETS', tickets: this.savedTickets }));
            }
        } else {
            localStorage.setItem('lotto49_tickets', JSON.stringify(this.savedTickets));
        }
        this.updateSavedTickets();
        this.showToast('Boleto eliminado', 'info');
      }
      updateSavedTickets() {
        const container = document.getElementById('savedTickets');
        if (!container) return;
        container.innerHTML = '';
        if (this.savedTickets.length === 0) {
          container.innerHTML = '<div style="color:#666; text-align: center; padding: 20px;">No tienes boletos guardados</div>';
          return;
        }

        const strategyMap = {
            simple: 'Simple',
            winning: 'E. Ganadora',
            multiple: 'M√∫ltiple'
        };

        this.savedTickets.forEach(ticket => {
          const item = document.createElement('div');
          item.className = 'saved-ticket-item';
          const strategyName = strategyMap[ticket.strategy] || 'Simple';
          const strategyHTML = `<span class="saved-ticket-strategy">${strategyName}</span>`;

          let combosHTML = ticket.combinations.map(combo => `<div class="saved-combination"><div class="saved-combination-content">${combo.map(n => `<div class="saved-combination-number">${n}</div>`).join('')}</div></div>`).join('');
          
          item.innerHTML = `<div class="saved-ticket-header">
              <span class="saved-ticket-date">${new Date(ticket.date).toLocaleString()}</span>
              ${strategyHTML}
              <div class="saved-ticket-actions">
                <button class="validate">Validar</button>
                <button class="delete-btn">X</button>
                <button class="toggle-btn">+</button>
              </div></div><div class="saved-combinations">${combosHTML}</div>`;
          
          item.querySelector('.delete-btn')?.addEventListener('click', () => this.deleteTicket(ticket.date));
          item.querySelector('.validate')?.addEventListener('click', () => this.startValidation(ticket.date));
          item.querySelector('.toggle-btn')?.addEventListener('click', (e) => {
              const comboDiv = item.querySelector('.saved-combinations');
              const target = e.target;
              if (!comboDiv || !target) return;
              const isVisible = comboDiv.style.display === 'block';
              comboDiv.style.display = isVisible ? 'none' : 'block';
              target.textContent = isVisible ? '+' : '-';
          });
          container.appendChild(item);
        });
      }
      startValidation(date) {
        this.currentValidatingTicket = this.savedTickets.find(t => t.date === date);
        const validationResults = document.getElementById('validationResults');
        if(validationResults) validationResults.innerHTML = '';
        const winningNumbersInput = document.getElementById('winningNumbersInput');
        if(winningNumbersInput) winningNumbersInput.value = '';
        this.toggleModal('validationModal', true);
      }
      confirmValidation() {
        const inputEl = document.getElementById('winningNumbersInput');
        if (!inputEl) return;
        const winningNumbers = new Set(inputEl.value.split(/[ ,.]+/).map(n => parseInt(n)).filter(n => !isNaN(n) && n > 0 && n < 50));
        if (winningNumbers.size !== 6) {
          this.showToast('Introduce 6 n√∫meros ganadores v√°lidos.', 'error');
          return;
        }
        const resultsDiv = document.getElementById('validationResults');
        if (!resultsDiv || !this.currentValidatingTicket) return;
        resultsDiv.innerHTML = '';
        this.currentValidatingTicket.combinations.forEach(combo => {
            if(combo.length === 6) {
                const hits = combo.filter(n => winningNumbers.has(n)).length;
                const resultItem = document.createElement('div');
                resultItem.className = 'saved-combination';
                resultItem.innerHTML = `<div class="saved-combination-content">${combo.map(n => `<div class="saved-combination-number ${winningNumbers.has(n) ? 'selected' : ''}">${n}</div>`).join('')}</div><div class="hit-count">${hits} aciertos</div>`;
                resultsDiv.appendChild(resultItem);
            }
        });
      }
      shareTicket() {
          if (!this.currentTicket) return;
          const text = `Mi boleto DataLotto49:\n${this.currentTicket.combinations.map(c => c.join(' - ')).join('\n')}`;
          if (navigator.share) {
              navigator.share({ title: 'Mi Boleto DataLotto49', text }).catch(console.error);
          } else {
              navigator.clipboard.writeText(text).then(() => this.showToast('Boleto copiado al portapapeles', 'success'));
          }
      }

      // ===== HELPERS UI & GEOMETRIC/AI =====
      hasGeometricPattern(combination, patternsToExclude) {
          const coords = combination.map(n => DataLotto49Advanced.NUMBER_COORDS[n]);
          const patternChecks = {
              lineas: () => this.isLine(coords),
              diagonales: () => this.isDiagonal(coords),
              triangulos: () => false, // No implementado para exclusi√≥n
              circulos: () => false,   // No implementado para exclusi√≥n
              cruces: () => false,     // No implementado para exclusi√≥n
          };
          for (const pattern of patternsToExclude) {
              if (patternChecks[pattern] && patternChecks[pattern]()) return true;
          }
          return false;
      }
      isSpaced(combination) {
          const coords = combination.map(n => DataLotto49Advanced.NUMBER_COORDS[n]);
          for (let i = 0; i < coords.length; i++) {
              for (let j = i + 1; j < coords.length; j++) {
                  if (Math.abs(coords[i].col - coords[j].col) <= 1 && Math.abs(coords[i].row - coords[j].row) <= 1) {
                      return false; // N√∫meros adyacentes encontrados
                  }
              }
          }
          return true;
      }
      isLine(coords) {
          const allSameRow = coords.every(c => c.row === coords[0].row);
          const allSameCol = coords.every(c => c.col === coords[0].col);
          return allSameRow || allSameCol;
      }
      isDiagonal(coords) {
          const mainDiagValue = coords[0].row - coords[0].col;
          if (coords.every(c => c.row - c.col === mainDiagValue)) return true;
          const antiDiagValue = coords[0].row + coords[0].col;
          if (coords.every(c => c.row + c.col === antiDiagValue)) return true;
          return false;
      }
      calculateCombinationScore(combination) {
          let score = 0;
          combination.forEach(n => {
              if (this.hotNumbers.has(n)) score += 2;
              // Only penalize cold numbers if regression filter is OFF
              if (!this.filters.useRegression && this.coldNumbers.has(n)) score -= 1;
          });

          if (this.filters.geometric.favor.includes('espaciados') && this.isSpaced(combination)) {
              score += 15;
          }
          if (this.filters.useMarkov) {
              score += this.getAIMarkovScore(combination);
          }
          if (this.filters.useNash) {
              score += (30 - this.getAIPopularityScore(combination));
          }
          if (this.filters.useRegression) {
              combination.forEach(n => {
                  if (this.coldNumbers.has(n)) score += 3; // Bonus for cold numbers
              });
          }
          return score;
      }
      getAIMarkovScore(combination) {
          if (this.historicalData.length < 5) return 0;
          let score = 0;
          const lastDraws = this.historicalData.slice(-5).flatMap(d => d.numbers);
          const lastDrawsSet = new Set(lastDraws);
          combination.forEach(n => {
              if (lastDrawsSet.has(n)) score += lastDraws.filter(d => d === n).length;
          });
          return score;
      }
      getAIPopularityScore(combination) {
          let score = 0;
          combination.forEach(n => {
              if (n <= 31) score += 2;
              const { row, col } = DataLotto49Advanced.NUMBER_COORDS[n];
              if (row === 0 || row === 6 || col === 0 || col === 6) score += 1;
          });
          if (this.isLine(combination.map(n => DataLotto49Advanced.NUMBER_COORDS[n]))) score += 10;
          return score;
      }
      showLoading(text) { 
        const loadingText = document.getElementById('loadingText');
        if (loadingText) loadingText.textContent = text;
        const loadingInfo = document.getElementById('loadingInfo');
        if (loadingInfo) loadingInfo.textContent = 'Iniciando...';
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal) loadingModal.style.display = 'flex'; 
      }
      hideLoading() { 
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal) loadingModal.style.display = 'none';
      }
      showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        if (!toast) return;
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => { toast.className = 'toast'; }, 3000);
      }
      toggleModal(id, show) { 
        const modal = document.getElementById(id);
        if (modal) modal.style.display = show ? 'flex' : 'none';
      }
      toggleCollapse(targetId) {
        const content = document.getElementById(`${targetId}Content`);
        const btn = document.getElementById(`${targetId}CollapseBtn`);
        if (content && btn) {
            content.classList.toggle('expanded');
            btn.textContent = content.classList.contains('expanded') ? '-' : '+';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.app = new DataLotto49Advanced();
    });
  </script>
</body>
</html>